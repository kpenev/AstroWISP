

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>astrowisp.utils.explore_prf &mdash; AstroWISP Python Interface  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/unlimited_width.css?v=eea1f72d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            AstroWISP Python Interface
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unit_tests.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python_interface/index.html">Python Interface Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_implementation/modules.html">Python Package Implementation</a></li>
<li class="toctree-l1"><a class="reference external" href="doxygen/index.xhtml#http://">C/C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_unit_tests/modules.html">Unit Testing Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AstroWISP Python Interface</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../utils.html">astrowisp.utils</a></li>
      <li class="breadcrumb-item active">astrowisp.utils.explore_prf</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for astrowisp.utils.explore_prf</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1">#pylint: disable=too-many-lines</span>

<span class="sd">&quot;&quot;&quot;Create some plots helpful for picking PSF grid.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_double</span><span class="p">,</span> <span class="n">c_char</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="c1">#import numpy</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">SmoothBivariateSpline</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1">#pylint: disable=import-error</span>
    <span class="kn">import</span> <span class="nn">xalglib</span>
    <span class="c1">#pylint: enable=import-error</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">configargparse</span> <span class="kn">import</span>\
    <span class="n">ArgumentParser</span><span class="p">,</span>\
    <span class="n">Action</span> <span class="k">as</span> <span class="n">ArgparseAction</span><span class="p">,</span>\
    <span class="n">DefaultsFormatter</span>


<span class="kn">from</span> <span class="nn">general_purpose_python_modules.kelly_colors</span> <span class="kn">import</span> <span class="n">kelly_colors</span>

<span class="kn">from</span> <span class="nn">astrowisp</span> <span class="kn">import</span> <span class="n">BackgroundExtractor</span><span class="p">,</span> <span class="n">FitStarShape</span><span class="p">,</span> <span class="n">SubPixPhot</span>
<span class="kn">from</span> <span class="nn">astrowisp.utils.file_utilities</span> <span class="kn">import</span>\
    <span class="n">get_fname_pattern_substitutions</span><span class="p">,</span>\
    <span class="n">prepare_file_output</span>
<span class="kn">from</span> <span class="nn">astrowisp.utils</span> <span class="kn">import</span> <span class="n">flux_from_magnitude</span>

<span class="c1">#pylint: disable=too-many-statements</span>
<div class="viewcode-block" id="parse_command_line">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.parse_command_line">[docs]</a>
<span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">assume_sources</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">add_config_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">add_frame_arg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the command line arguments as attributes of an object.</span>

<span class="sd">    Args:</span>
<span class="sd">        parser(ArgumentParser):    If not None, should be a valid command line</span>
<span class="sd">            parser to which further arguments are addded by this method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        See ArgumentParser.parse_args().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Interface mandated by argparse.</span>
    <span class="c1">#pylint: disable=too-few-public-methods</span>
    <span class="k">class</span> <span class="nc">ValidateBinning</span><span class="p">(</span><span class="n">ArgparseAction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Properly parse the different type arguments specifying binning.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Add dictionary with binning configuration to namespace.&quot;&quot;&quot;</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;statistic&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])})</span>
    <span class="c1">#pylint: enable=too-few-public-methods</span>

    <span class="k">def</span> <span class="nf">parse_image_split</span><span class="p">(</span><span class="n">split_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the image split argument to a tuple of (direction, value).&quot;&quot;&quot;</span>

        <span class="n">direction</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">split_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">direction</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">parse_slice</span><span class="p">(</span><span class="n">slice_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse slice arguments to dictionaries directly usable as kwargs.&quot;&quot;&quot;</span>

        <span class="n">direction</span><span class="p">,</span> <span class="n">slice_str</span> <span class="o">=</span> <span class="n">slice_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="n">offset</span><span class="p">,</span> <span class="n">thickness</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                             <span class="k">for</span> <span class="n">val_str</span> <span class="ow">in</span> <span class="n">slice_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+-&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;_offset&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
                <span class="s1">&#39;thickness&#39;</span><span class="p">:</span> <span class="n">thickness</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span>
            <span class="n">default_config_files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;explore_prf.cfg&#39;</span><span class="p">],</span>
            <span class="n">formatter_class</span><span class="o">=</span><span class="n">DefaultsFormatter</span><span class="p">,</span>
            <span class="n">ignore_unknown_config_file_keys</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">add_frame_arg</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;frame_fname&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The full path of the FITS file to use for creating the plots.&#39;</span>
        <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--prf-range&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Width, height, x and y offset of the source extraction center &quot;</span>
        <span class="s2">&quot;from the lower left corner. Default: `</span><span class="si">%(default)s</span><span class="s2">&#39;.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--background-annulus&#39;</span><span class="p">,</span> <span class="s1">&#39;--bg&#39;</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The inner and outer radius of the annulus used to measure the &#39;</span>
        <span class="s1">&#39;background of sources. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--flux-aperture&#39;</span><span class="p">,</span> <span class="s1">&#39;--aperture&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The aperture to use for measuring the flux (normalization of the &#39;</span>
        <span class="s1">&#39;pixel values when plotting. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--slice&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">parse_slice</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Add more slices to show. Each slice is specified as an offset &#39;</span>
        <span class="s1">&#39;along one if the demensions (x or y) and a range around that to &#39;</span>
        <span class="s1">&#39;include in the plot. White space around tokens is allowed and &#39;</span>
        <span class="s1">&#39;ignored. Example: &quot;x = 0 +- 0.1&quot;. By default plot slices at x=0 and &#39;</span>
        <span class="s1">&#39;y=0 with width of 0.2.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--split-image&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">parse_image_split</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify another boundary (in x or y) to spling the image into &#39;</span>
        <span class="s1">&#39;regions. A separate plot of the PRF is generated for each region. The &#39;</span>
        <span class="s1">&#39;format is like &quot;x/y=&lt;value&gt;&quot;, and the option can be specified multiple&#39;</span>
        <span class="s1">&#39; times.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--discard-image-boundary&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If passed, slices on the outside boundary of the image are not &#39;</span>
        <span class="s1">&#39;plotted.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--error-scale&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Scale the error bars by this value when plotting to make a more &#39;</span>
        <span class="s1">&#39;readable plot. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--error-threshold&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Points with error bars larger than this are not included in the &#39;</span>
        <span class="s1">&#39;plot. Intended to avoid introducing points that are too noisy. &#39;</span>
        <span class="s1">&#39;Default: </span><span class="si">%(default)s</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--add-binned&#39;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">action</span><span class="o">=</span><span class="n">ValidateBinning</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;NBINS&#39;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If supplied, in addition to pixel values, a binned curve is also &#39;</span>
        <span class="s1">&#39;displayed using the specified binning statistic and number of bins.&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assume_sources</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--trans-pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(FITS_DIR)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;..&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;ASTROM&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;</span><span class="si">%(FITS_ROOT)s</span><span class="s1">.trans&#39;</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A pattern with substitutions involving any FITS header &quot;</span>
            <span class="s2">&quot;keyword, `&#39;</span><span class="si">%%</span><span class="s2">(FITS_DIR)s&#39;` (directory containing the frame), &quot;</span>
            <span class="s2">&quot;and/or `&#39;</span><span class="si">%%</span><span class="s2">(FITS_ROOT)s&#39;` (base filename of the frame without the &quot;</span>
            <span class="s2">&quot;`fits` or `fits.fz` extension) that expands to the `.trans` file &quot;</span>
            <span class="s2">&quot;corresponding to the input frame. Default: &#39;</span><span class="si">%(default)s</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--catalogue-pattern&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(FITS_DIR)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;..&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;MASTERS&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;</span><span class="si">%(FILTER)c</span><span class="s1">_catalogue.ucac4&#39;</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A pattern with substitutions involving any FITS header &quot;</span>
            <span class="s2">&quot;keywordd, `&#39;</span><span class="si">%%</span><span class="s2">(FITS_DIR)s&#39;` (directory containing the frame), &quot;</span>
            <span class="s2">&quot;and/or `&#39;</span><span class="si">%%</span><span class="s2">(FITS_ROOT)s&#39;` (base filename of the frame without the &quot;</span>
            <span class="s2">&quot;`fits` or `fits.fz` extension) that expands to the full path of &quot;</span>
            <span class="s2">&quot;the catalogue containing all sources in the image. Default: &quot;</span>
            <span class="s2">&quot;&#39;</span><span class="si">%(default)s</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="n">spline_config</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spline configuration&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Options controlling the bicubic spline interpolation used &#39;</span>
        <span class="s1">&#39;to represent the PRF in each image piece.&#39;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-method&#39;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alglib&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;alglib&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Which of the supported spline fitting methods to use. Default: &#39;</span>
        <span class="s1">&#39;</span><span class="si">%(default)s</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-resolution&#39;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The grid to use if the spline method is &#39;alglib&#39;. Ignored if the &quot;</span>
        <span class="s2">&quot;method is &#39;scipy&#39;. Default: </span><span class="si">%(default)s</span><span class="s2">.&quot;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-smoothing&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;For scipy splines, the bi-cubic spline derived has a smoothing &#39;</span>
        <span class="s1">&#39;factor equal to this value times the number of points at which PRF &#39;</span>
        <span class="s1">&#39;measurements are available. For alglib splines, this is directly &#39;</span>
        <span class="s1">&#39;the smoothing penalty used. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-pad-fraction&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The fraction of the PRF grid box to add with zero-valued padding &#39;</span>
        <span class="s1">&#39;past the edges. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-pad-npoints&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The number of zero valued points, in each direction to add within&#39;</span>
        <span class="s1">&#39;each padding region. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
    <span class="n">spline_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--spline-spacing&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The number of evenly spaced points to pass to the spline for x &#39;</span>
        <span class="s1">&#39;and y. Default: </span><span class="si">%(default)s</span><span class="s1">.&#39;</span>
    <span class="p">)</span>

    <span class="n">plot_config</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Plotting configuration&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Options that control the layout and other aspects of the &#39;</span>
        <span class="s1">&#39;plots generated.&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--figure-dpi&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The resolution to set for generated plots.&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--marker-size&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The size of the markers to use in plots.&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-y-range&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If specified, the generated plot displays exactly the given range&#39;</span>
        <span class="s1">&#39; of y values.&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-3d-spline&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, the plots will be generated as 3D images of the spline&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--save-3d-spline-plot&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This should be a template for the filename for plotting the &quot;</span>
        <span class="s2">&quot;3D prf involving `&#39;</span><span class="si">%%</span><span class="s2">(XSPLIT)s&#39;` and `&#39;</span><span class="si">%%</span><span class="s2">(YSPLIT)s&#39;` which get &quot;</span>
        <span class="s2">&quot;substituted by the image slices given, and/or any FITS header keyword,&quot;</span>
        <span class="s2">&quot; and/or `&#39;</span><span class="si">%%</span><span class="s2">(FITS_DIR)s&#39;` (directory containing the frame), &quot;</span>
        <span class="s2">&quot;`&#39;</span><span class="si">%%</span><span class="s2">(FITS_ROOT)s&#39;` (base filename of the frame without any &quot;</span>
        <span class="s2">&quot;extensions). This should be enabled with plot-3d-spline if you want &quot;</span>
        <span class="s2">&quot;plots to be saved otherwise plots will just be shown&quot;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-3d-spline-contour-stride&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The stride amount (int) for the 3D contour plot generated by &#39;</span>
        <span class="s1">&#39;plot-3d-spline&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-3d-spline-contour-linewidths&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The The line width of the contour lines (float) for the 3D &#39;</span>
        <span class="s1">&#39;contour plot generated by plot-3d-spline&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-multi-image&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, the plots will be generated as multiple separate images,&#39;</span>
             <span class="s1">&#39; instead of stacked on top of one another&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--plot-entire-prf&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If true, will generate a plot of the entire prf on a 3d scale.&#39;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--save-prf-plot&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This should be a template for the filename for plotting the &quot;</span>
        <span class="s2">&quot;entire prf involving `&#39;</span><span class="si">%%</span><span class="s2">(XSPLIT)s&#39;` and `&#39;</span><span class="si">%%</span><span class="s2">(YSPLIT)s&#39;` which get &quot;</span>
        <span class="s2">&quot;substituted by the image slices given, and/or any FITS header keyword,&quot;</span>
        <span class="s2">&quot; and/or `&#39;</span><span class="si">%%</span><span class="s2">(FITS_DIR)s&#39;` (directory containing the frame), &quot;</span>
        <span class="s2">&quot;`&#39;</span><span class="si">%%</span><span class="s2">(FITS_ROOT)s&#39;` (base filename of the frame without any &quot;</span>
        <span class="s2">&quot;extensions).&quot;</span>
    <span class="p">)</span>
    <span class="n">plot_config</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--save-plot-pattern&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If this option is not specified, plots will be displayed, &quot;</span>
        <span class="s2">&quot;otherwise, this should be a template for the filename involving &quot;</span>
        <span class="s2">&quot;any FITS header keywords, `&#39;</span><span class="si">%%</span><span class="s2">(FITS_DIR)s&#39;` (directory containing the &quot;</span>
        <span class="s2">&quot;frame), `&#39;</span><span class="si">%%</span><span class="s2">(FITS_ROOT)s&#39;` (base filename of the frame without any &quot;</span>
        <span class="s2">&quot;extensions), </span><span class="si">%%</span><span class="s2">(SLICEDIR), and </span><span class="si">%%</span><span class="s2">(SLICEOFFSET) substitutions which get&quot;</span>
        <span class="s2">&quot; substituted by the direction (`</span><span class="se">\&#39;</span><span class="s2">x</span><span class="se">\&#39;</span><span class="s2">` or `</span><span class="se">\&#39;</span><span class="s2">y</span><span class="se">\&#39;</span><span class="s2">`) and the offset of &quot;</span>
        <span class="s2">&quot;the slice in the plot. If using plot-multi-image option include &quot;</span>
        <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">(XSPLIT)s and </span><span class="si">%%</span><span class="s2">(YSPLIT)s which get substituted by the image &quot;</span>
        <span class="s2">&quot;slices given.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--skip-existing-plots&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this argument is enabled, if the output file for a plot &#39;</span>
        <span class="s1">&#39;exists, the plot is not re-generated. This allows saving the time to &#39;</span>
        <span class="s1">&#39;calculate the required data if all plots exist.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--overwrite-plots&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If a plot exists, without this argument or --skip-existing-plots,&#39;</span>
        <span class="s1">&#39; the script exists with an error.&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">add_config_file</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
            <span class="n">is_config_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Config file to use instead of default.&#39;</span>
        <span class="p">)</span>

    <span class="c1">#TODO write common line argument for markersize for plots</span>
    <span class="n">cmdline_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assume_sources</span><span class="p">:</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">catalogue</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">catalogue_pattern</span>
            <span class="o">%</span>
            <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_slice</span><span class="p">(</span><span class="s1">&#39;x = 0 +- 0.2&#39;</span><span class="p">),</span>
                              <span class="n">parse_slice</span><span class="p">(</span><span class="s1">&#39;y = 0 +- 0.2&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">cmdline_args</span></div>

<span class="c1">#pylint: enable=too-many-statements</span>


<div class="viewcode-block" id="get_trans_fname">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_trans_fname">[docs]</a>
<span class="k">def</span> <span class="nf">get_trans_fname</span><span class="p">(</span><span class="n">frame_fname</span><span class="p">,</span> <span class="n">trans_pattern</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the filename of the trans file corresponding to a given frame.</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_fname(str):    The filename of the FITS frame used for plotting.</span>

<span class="sd">        trans_pattern(str):    The pattern for the filename of the</span>
<span class="sd">            transformation file specified on the command line.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str:</span>
<span class="sd">            The filename of the transformation file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">trans_fname</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">trans_pattern</span>
        <span class="o">%</span>
        <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span><span class="n">frame_fname</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">trans_fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transformation file </span><span class="si">{</span><span class="n">trans_fname</span><span class="si">!r}</span><span class="s1"> does not exist!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trans_fname</span></div>



<div class="viewcode-block" id="get_source_positions">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_source_positions">[docs]</a>
<span class="k">def</span> <span class="nf">get_source_positions</span><span class="p">(</span><span class="n">catalogue_fname</span><span class="p">,</span> <span class="n">trans_fname</span><span class="p">,</span> <span class="n">image_resolution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return [(x, y), ...] positions of the sources in the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        catalogue_fname(str):    The filename of a catalogue query containing</span>
<span class="sd">            all sources in the image (could contain more).</span>

<span class="sd">        trans_fname(str):   The filename of the grtrans file for transforming</span>
<span class="sd">            tan-projected (xi, eta) to image positions.</span>

<span class="sd">        image_resolution((x_res, y_res)):   The resolution of the input image.</span>
<span class="sd">            Used to determine which sources project outside the image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [(float, float), ...]:</span>
<span class="sd">            A list of the (x, y) positions of the sources in the image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">in_image</span><span class="p">(</span><span class="n">xy_tuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True iff the given (x, y) tuple is inside the image.&quot;&quot;&quot;</span>

        <span class="c1">#x and y are perfectly valid names</span>
        <span class="c1">#pylint: disable=invalid-name</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy_tuple</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">image_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="ow">and</span>
            <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">image_resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1">#pylint: enable=invalid-name</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">trans_fname</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;# 2MASS:&#39;</span><span class="p">):</span>
                <span class="n">field_center</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>

    <span class="n">get_xi_eta_cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s1">&#39;grtrans&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="n">catalogue_fname</span><span class="p">,</span>
            <span class="s1">&#39;--wcs&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tan,degrees,ra=</span><span class="si">{</span><span class="n">field_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,dec=</span><span class="si">{</span><span class="n">field_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--col-radec&#39;</span><span class="p">,</span> <span class="s1">&#39;2,3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--col-out&#39;</span><span class="p">,</span> <span class="s1">&#39;2,3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span>
        <span class="p">],</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="p">)</span>

    <span class="n">get_x_y_cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s1">&#39;grtrans&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--col-xy&#39;</span><span class="p">,</span> <span class="s1">&#39;2,3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--input-transformation&#39;</span><span class="p">,</span> <span class="n">trans_fname</span><span class="p">,</span>
            <span class="s1">&#39;--col-out&#39;</span><span class="p">,</span> <span class="s1">&#39;2,3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span>
        <span class="p">],</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">get_xi_eta_cmd</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="n">get_xi_eta_cmd</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">projected_sources</span> <span class="o">=</span> <span class="n">get_x_y_cmd</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">filter</span><span class="p">(</span>
            <span class="n">in_image</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">projected_sources</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_source_info">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_source_info">[docs]</a>
<span class="k">def</span> <span class="nf">get_source_info</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                    <span class="n">pixel_array</span><span class="p">,</span>
                    <span class="n">stddev_array</span><span class="p">,</span>
                    <span class="n">mask_array</span><span class="p">,</span>
                    <span class="n">source_positions</span><span class="p">,</span>
                    <span class="n">aperture</span><span class="p">,</span>
                    <span class="n">bg_radii</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return field array containing source positions, fluxes and backgrounds.</span>

<span class="sd">    Args:</span>
<span class="sd">        pixel_array (2-D array like):    The measured values of the image</span>
<span class="sd">            pixels.</span>

<span class="sd">        stddev_array (2-D array like):    The estimated variance of the image</span>
<span class="sd">            pixels.</span>

<span class="sd">        mask_array (2-D array like):    Quality flags for the image pixels.</span>

<span class="sd">        source_positions:    The return value from get_source_positions().</span>

<span class="sd">        aperture:    The size of the aperture to use for measuring the flux.</span>

<span class="sd">        bg_radii((float, float)):    The inner and outer radius to use for the</span>
<span class="sd">            background annulus.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (scipy field array):</span>
<span class="sd">            All relevant source information in the following fields:</span>

<span class="sd">                - x: The x coordinates of the sources.</span>

<span class="sd">                - y: The y coordinates of the sources.</span>

<span class="sd">                - flux: The measured fluxes of the sources.</span>

<span class="sd">                - flux_err: Estimated error of the flux.</span>

<span class="sd">                - bg: The measured backgrounds of the sources.</span>

<span class="sd">                - bg_err: Estimated error of the background.</span>

<span class="sd">                - bg_npix: The number of pixels used in determining the</span>
<span class="sd">                  background.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_flux_info</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">measure_background</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Measure the flux of the sources and add to result.&quot;&quot;&quot;</span>

        <span class="n">fit_star_shape</span> <span class="o">=</span> <span class="n">FitStarShape</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;PSF&#39;</span><span class="p">,</span>
            <span class="n">shape_terms</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">aperture</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">aperture</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">aperture</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">aperture</span><span class="p">]],</span>
            <span class="n">initial_aperture</span><span class="o">=</span><span class="n">aperture</span><span class="p">,</span>
            <span class="n">bg_min_pix</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">src_min_pix</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">src_min_signal_to_noise</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">src_max_aperture</span><span class="o">=</span><span class="mf">1000.0</span>
        <span class="p">)</span>
        <span class="n">result_tree</span> <span class="o">=</span> <span class="n">fit_star_shape</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">pixel_array</span><span class="p">,</span>
                    <span class="n">stddev_array</span><span class="p">,</span>
                    <span class="n">mask_array</span><span class="p">,</span>
                    <span class="n">result</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">measure_background</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">get_flux</span> <span class="o">=</span> <span class="n">SubPixPhot</span><span class="p">(</span><span class="n">apertures</span><span class="o">=</span><span class="p">[</span><span class="n">aperture</span><span class="p">])</span>
        <span class="n">get_flux</span><span class="p">(</span>
            <span class="p">(</span><span class="n">pixel_array</span><span class="p">,</span> <span class="n">stddev_array</span><span class="p">,</span> <span class="n">mask_array</span><span class="p">),</span>
            <span class="n">result_tree</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_from_magnitude</span><span class="p">(</span>
            <span class="n">result_tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;apphot.mag.0.0&#39;</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">get_flux</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;magnitude_1adu&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_positions</span><span class="p">),</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;S5&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;bg_err&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;bg_npix&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">uint64</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">)])</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">src_x</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">source_positions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_double</span><span class="p">)</span>
    <span class="n">src_y</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">source_positions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_double</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">int_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">][</span><span class="n">int_id</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">int_id</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_x</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_y</span>

    <span class="n">measure_background</span> <span class="o">=</span> <span class="n">BackgroundExtractor</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">,</span> <span class="o">*</span><span class="n">bg_radii</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;bg&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;bg_err&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;bg_npix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure_background</span><span class="p">(</span>
        <span class="n">src_x</span><span class="p">,</span>
        <span class="n">src_y</span>
    <span class="p">)</span>

    <span class="n">add_flux_info</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">measure_background</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<span class="c1">#No clean way to simplify found.</span>
<span class="c1">#pylint: disable=too-many-locals</span>
<div class="viewcode-block" id="find_pixel_offsets">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.find_pixel_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">find_pixel_offsets</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                       <span class="n">prf_range</span><span class="p">,</span>
                       <span class="n">image_resolution</span><span class="p">,</span>
                       <span class="n">crowding_distance</span><span class="p">,</span>
                       <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the positions of pixels within prf range relative to source centers.</span>

<span class="sd">    Args:</span>
<span class="sd">        sources:    The return value of get_source_info().</span>

<span class="sd">        prf_range:    See `--prf-range` command line argument.</span>

<span class="sd">        image_resolution(int, int):    The x and y resolution of the image under</span>
<span class="sd">            investigation.</span>

<span class="sd">        crowding_distance(float):    The minimum distance between a source and</span>
<span class="sd">            its closest neighbor to still consider the source isolated.</span>

<span class="sd">        plot(bool):    If True, show plots of the offsets and norm images.</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-D field array:</span>

<span class="sd">            * `x_off`: The field giving the offset of the pixel center from</span>
<span class="sd">              the source position in the x direction</span>

<span class="sd">            * `y_off`: The field giving the offset of the pixel center from</span>
<span class="sd">              the source position in the y direction</span>

<span class="sd">            * `norm`: The normalization to use for the pixel response.</span>

<span class="sd">            Pixels that are not within range of any PSF or that are within more</span>
<span class="sd">            than one PSF&#39;s range have `nan` entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="n">image_resolution</span><span class="p">,</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x_off&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;y_off&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;zero_point&#39;</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">float64</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">image_resolution</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1">#False positive.</span>
    <span class="c1">#pylint: disable=no-member</span>
    <span class="n">source_tree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]])</span>
    <span class="c1">#pylint: enable=no-member</span>
    <span class="n">crowded_flags</span> <span class="o">=</span> <span class="n">source_tree</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">source_tree</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">crowding_distance</span><span class="p">,</span>
                                                 <span class="n">return_length</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">this_source</span><span class="p">,</span> <span class="n">crowded</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">crowded_flags</span><span class="p">):</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">image_resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">prf_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">image_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">result_patch</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">min_y</span> <span class="p">:</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span> <span class="p">:</span> <span class="n">max_x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">crowded</span><span class="p">:</span>
            <span class="n">shared</span><span class="p">[</span><span class="n">min_y</span> <span class="p">:</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span> <span class="p">:</span> <span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shared</span><span class="p">[</span>
                <span class="n">min_y</span> <span class="p">:</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span> <span class="p">:</span> <span class="n">max_x</span>
            <span class="p">][</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result_patch</span><span class="p">[</span><span class="s1">&#39;x_off&#39;</span><span class="p">])</span>
            <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">result_patch</span><span class="p">[</span><span class="s1">&#39;x_off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">)</span>
                                 <span class="o">-</span>
                                 <span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                                 <span class="o">+</span>
                                 <span class="mf">0.5</span><span class="p">)</span>

        <span class="n">result_patch</span><span class="p">[</span><span class="s1">&#39;y_off&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">)</span>
                                                <span class="o">-</span>
                                                <span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                                                <span class="o">+</span>
                                                <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">result_patch</span><span class="p">[</span><span class="s1">&#39;zero_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;bg&#39;</span><span class="p">]</span>
        <span class="n">result_patch</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_source</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;x_off&#39;</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_off&#39;</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></div>

<span class="c1">#pylint: enable=too-many-locals</span>


<div class="viewcode-block" id="get_prf_data">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_prf_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_prf_data</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">,</span>
                 <span class="n">pixel_stddev</span><span class="p">,</span>
                 <span class="n">pixel_offsets</span><span class="p">,</span>
                 <span class="n">error_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the PRF measurements for (a subset of) the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        pixel_values(2-D float array):    The calibrated pixel responses from</span>
<span class="sd">            the image to include in the plot.</span>

<span class="sd">        pixel_stddev(2-D float array):    The estimated standard deviation of</span>
<span class="sd">            `pixel_values`.</span>

<span class="sd">        pixel_offsets:    The slice of the return value of find_pixel_offsets()</span>
<span class="sd">            corresponding to `pixel_values`.</span>

<span class="sd">        error_threshold(float):    See `--error-threshold` command line</span>
<span class="sd">            argument</span>

<span class="sd">    Returns:</span>
<span class="sd">        (2-D float array, 2-D float array, 2-D float array, 2-D float array):</span>

<span class="sd">            * The x-offsets of the points at which PRF measurements are</span>
<span class="sd">              available.</span>

<span class="sd">            * The y-offsets of the points at which PRF measurements are</span>
<span class="sd">              available.</span>

<span class="sd">            * The measured normalized PRF at the available offsets</span>

<span class="sd">            * estimated errors of the PRF measurements.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prf_measurements</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pixel_values</span>
            <span class="o">-</span>
            <span class="n">pixel_offsets</span><span class="p">[</span><span class="s1">&#39;zero_point&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">/</span>
        <span class="n">pixel_offsets</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">prf_errors</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pixel_stddev</span>
        <span class="o">/</span>
        <span class="n">pixel_offsets</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1">#False positive</span>
    <span class="c1">#pylint: disable=assignment-from-no-return</span>
    <span class="n">include</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prf_measurements</span><span class="p">),</span>
                                <span class="n">scipy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">prf_errors</span><span class="p">))</span>
    <span class="n">include</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">prf_errors</span> <span class="o">&lt;</span> <span class="n">error_threshold</span><span class="p">)</span>
    <span class="c1">#pylint: enable=assignment-from-no-return</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span>
        <span class="n">pixel_offsets</span><span class="p">[</span><span class="s1">&#39;x_off&#39;</span><span class="p">][</span><span class="n">include</span><span class="p">],</span>
        <span class="n">pixel_offsets</span><span class="p">[</span><span class="s1">&#39;y_off&#39;</span><span class="p">][</span><span class="n">include</span><span class="p">],</span>
        <span class="n">prf_measurements</span><span class="p">[</span><span class="n">include</span><span class="p">],</span>
        <span class="n">prf_errors</span><span class="p">[</span><span class="n">include</span><span class="p">]</span>
    <span class="p">))</span></div>



<span class="c1">#TODO: see if can be fixed</span>
<span class="c1">#pylint: disable=too-many-locals</span>
<div class="viewcode-block" id="plot_prf_slice">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.plot_prf_slice">[docs]</a>
<span class="k">def</span> <span class="nf">plot_prf_slice</span><span class="p">(</span><span class="n">prf_data</span><span class="p">,</span>
                   <span class="n">spline</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">label</span><span class="p">,</span>
                   <span class="n">x_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">y_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">thickness</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="n">error_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="n">points_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                   <span class="n">marker_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="o">**</span><span class="n">binning</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a slice of the PRF.</span>

<span class="sd">    Args:</span>
<span class="sd">        prf_data:    The return value of get_prf_data().</span>

<span class="sd">        x_offset/y_offset(float):    Plot a slice of constant x or y (determined</span>
<span class="sd">            by the argument name) offset from the source center.</span>

<span class="sd">        thickness(float):    Points with x or y within `thickness` of the</span>
<span class="sd">            specified offset are included in the plot.</span>

<span class="sd">        error_scale(float):    See `--error-scale` command line argument.</span>

<span class="sd">        error_threshold(float):    See `--error-threshold` command line</span>
<span class="sd">            argument.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">x_offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="ow">or</span>
        <span class="p">(</span><span class="n">x_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">prf_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">assert</span> <span class="n">entry</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">x_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_pixel_indices</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thickness</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spline_x</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">spline_y</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">spline_x</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_pixel_indices</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thickness</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spline_x</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">spline_y</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">spline_x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">plot_x</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span>
        <span class="mi">0</span> <span class="k">if</span> <span class="n">x_offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="p">][</span>
        <span class="n">plot_pixel_indices</span>
    <span class="p">]</span>

    <span class="n">plot_y</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">plot_pixel_indices</span><span class="p">]</span>

    <span class="n">plot_err_y</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">plot_pixel_indices</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot_x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">pyplot</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span>
                    <span class="n">plot_y</span><span class="p">,</span>
                    <span class="n">plot_err_y</span> <span class="o">*</span> <span class="n">error_scale</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">points_color</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">marker_size</span><span class="p">,</span>
                    <span class="n">elinewidth</span><span class="o">=</span><span class="p">(</span><span class="n">marker_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spline_x</span><span class="p">,</span>
                    <span class="n">spline_y</span><span class="p">,</span>
                    <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binning</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span>
                                         <span class="n">plot_x</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">binning</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span>
                                         <span class="n">plot_y</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">binning</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;o&#39;</span><span class="p">,</span>
            <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">points_color</span><span class="p">,</span>
            <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">marker_size</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="p">)</span></div>

<span class="c1">#pylint: enable=too-many-locals</span>


<div class="viewcode-block" id="plot_entire_prf">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.plot_entire_prf">[docs]</a>
<span class="k">def</span> <span class="nf">plot_entire_prf</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">,</span>
                    <span class="n">image_slices</span><span class="p">,</span>
                    <span class="n">grid_x</span><span class="p">,</span>
                    <span class="n">grid_y</span><span class="p">,</span>
                    <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the entire PRF on a 3d axes and displays it to the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmdline_args:    The parsed command line arguments.</span>

<span class="sd">        image_slices:    How to split the image when plotting (the return</span>
<span class="sd">            value of get_image_slices())</span>

<span class="sd">        grid_x:     The PSF x-grid, pulled from star_shape_grid</span>

<span class="sd">        grid_y:     The PSF y-grid, pulled from star_shape_grid</span>

<span class="sd">        sources(scipy.array or None):    If not None, it should be an array with</span>
<span class="sd">            equivalent structure to get_source_info(). If None,</span>
<span class="sd">            get_source_info() is used to initialize it.</span>


<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">output_plot</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">,</span> <span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save or display the currently set up plot.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_prf_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">substitutions</span> <span class="o">=</span> <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span>
        <span class="p">)</span>
        <span class="n">substitutions</span><span class="p">[</span><span class="s1">&#39;x_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_index</span><span class="p">)</span>
        <span class="n">substitutions</span><span class="p">[</span><span class="s1">&#39;y_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_index</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_prf_plot</span> <span class="o">%</span> <span class="n">substitutions</span>
        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">prepare_file_output</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                          <span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span><span class="p">,</span>
                                          <span class="kc">True</span><span class="p">,</span>
                                          <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">skip_existing_plots</span> <span class="ow">and</span> <span class="n">file_exists</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                       <span class="n">dpi</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">figure_dpi</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_slice</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">pixel_offsets</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">,</span> <span class="n">y_image_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the PRF of one slice of the image.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;first_hdu=&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">first_hdu</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x_image_slice=&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y_image_slice=&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">y_image_slice</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame_length=&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)))</span>

        <span class="n">prf_data</span> <span class="o">=</span> <span class="n">get_prf_data</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
            <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
            <span class="n">pixel_offsets</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">error_threshold</span>
        <span class="p">)</span>
        <span class="n">plot_x</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plot_y</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plot_z</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># 3D</span>
        <span class="c1"># minz = numpy.amin(plot_z)</span>
        <span class="c1"># maxz = numpy.amax(plot_z)</span>
        <span class="c1"># norm_z = (plot_z - plot_z.min()) / plot_z.max()</span>
        <span class="c1"># colors = cm.hsv(norm_z)</span>
        <span class="c1"># ax = pyplot.axes(projection=&#39;3d&#39;)</span>
        <span class="c1"># ax.scatter3D(plot_x,</span>
        <span class="c1">#              plot_y,</span>
        <span class="c1">#              plot_z,</span>
        <span class="c1">#              cmap=colors,</span>
        <span class="c1">#              c=colors,</span>
        <span class="c1">#              s=10,</span>
        <span class="c1">#              marker=&#39;o&#39;,</span>
        <span class="c1">#              alpha=0.3,</span>
        <span class="c1">#              vmin=minz,</span>
        <span class="c1">#              vmax=maxz</span>
        <span class="c1">#              )</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span>
                       <span class="n">plot_y</span><span class="p">,</span>
                       <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">,</span>
                       <span class="n">c</span><span class="o">=</span><span class="n">plot_z</span><span class="p">,</span>
                       <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.001</span><span class="p">,</span>
                       <span class="n">vmax</span><span class="o">=</span><span class="mf">0.15</span>
                       <span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">grid_x</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">grid_y</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid_y</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid_x</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">frame</span><span class="p">:</span>
        <span class="c1"># False positive</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]:</span>
            <span class="n">image_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span>
                                <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
            <span class="n">first_hdu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span>
                                <span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
            <span class="n">first_hdu</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># pylint: enable=no-member</span>

        <span class="k">assert</span> <span class="n">image_resolution</span> <span class="o">==</span> <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">get_source_info</span><span class="p">(</span>
                <span class="n">pixel_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                <span class="n">stddev_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                <span class="n">mask_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">c_char</span><span class="p">),</span>
                <span class="n">source_positions</span><span class="o">=</span><span class="n">get_source_positions</span><span class="p">(</span>
                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">catalogue</span><span class="p">,</span>
                    <span class="n">get_trans_fname</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span><span class="p">,</span>
                                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">trans_pattern</span><span class="p">),</span>
                    <span class="n">image_resolution</span>
                <span class="p">),</span>
                <span class="n">aperture</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">flux_aperture</span><span class="p">,</span>
                <span class="n">bg_radii</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">background_annulus</span>
            <span class="p">)</span>

        <span class="n">pixel_offsets</span> <span class="o">=</span> <span class="n">find_pixel_offsets</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                                           <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">,</span>
                                           <span class="n">image_resolution</span><span class="p">,</span>
                                           <span class="mf">2.0</span> <span class="o">*</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">flux_aperture</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x_image_slice</span><span class="p">,</span> <span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span> <span class="ow">in</span> <span class="n">image_slices</span><span class="p">:</span>

            <span class="n">plot_slice</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">pixel_offsets</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">,</span> <span class="n">y_image_slice</span><span class="p">)</span>
            <span class="n">output_plot</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">,</span>
                        <span class="n">y_image_slice</span><span class="p">,</span>
                        <span class="n">x_index</span><span class="p">,</span>
                        <span class="n">y_index</span><span class="p">)</span></div>


            <span class="c1">#TODO need to manually set vmin and vmax make color have a</span>
            <span class="c1">#wider range try to find color limit, should make them quantiles</span>
            <span class="c1">#functions</span>

<div class="viewcode-block" id="plot_3d_prf">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.plot_3d_prf">[docs]</a>
<span class="k">def</span> <span class="nf">plot_3d_prf</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">,</span> <span class="n">meshgrid_x</span><span class="p">,</span> <span class="n">meshgrid_y</span><span class="p">,</span> <span class="n">prf_slice_splines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a 3D slice of the PRF.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmdline_args: The parse command line configuration.</span>

<span class="sd">        meshgrid_x, meshgrid_y:   The meshgrid generated for evaluating the PRF</span>
<span class="sd">            made from the grid points of the star_shape_grid</span>

<span class="sd">        prf_slice_splines:    The evaluated PRF at the meshgrid points extracted</span>
<span class="sd">            from slice_splines</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">plot_3d_slice</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">meshgrid_x</span><span class="p">,</span> <span class="n">meshgrid_y</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">linewidths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the 3D PRF of one slice of the image.&quot;&quot;&quot;</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span>
            <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">contour3D</span><span class="p">(</span>
            <span class="n">meshgrid_x</span><span class="p">,</span>
            <span class="n">meshgrid_y</span><span class="p">,</span>
            <span class="n">spline</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">meshgrid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">stride</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_3d_plot_tasks</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for all the 3D plots that must be created.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdline_args:    The parse command line configuration.</span>

<span class="sd">        Yields:</span>
<span class="sd">            [(str on None), ...]: List of the filenames to save the plot if each</span>
<span class="sd">                slice is saved separately. Appropriate length of Nones</span>
<span class="sd">                otherwise.</span>

<span class="sd">            str or None: The filename to save a combined plot of all pieces of</span>
<span class="sd">                the image together or None if individual images are saved</span>
<span class="sd">                separately.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_3d_image_slice_fname</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">,</span>
                                     <span class="n">y_image_slice</span><span class="p">,</span>
                                     <span class="n">x_index</span><span class="p">,</span>
                                     <span class="n">y_index</span><span class="p">,</span>
                                     <span class="n">fname_substitutions</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return a single ently of the plotting tasks per image silce.&quot;&quot;&quot;</span>

            <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;XSPLIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_index</span><span class="p">)</span>
                                             <span class="k">if</span> <span class="n">x_image_slice</span> <span class="k">else</span>
                                             <span class="kc">None</span><span class="p">)</span>
            <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;YSPLIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_index</span><span class="p">)</span>
                                             <span class="k">if</span> <span class="n">y_image_slice</span> <span class="k">else</span>
                                             <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_3d_spline_plot</span> <span class="o">%</span> <span class="n">fname_substitutions</span>
                <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span> <span class="k">else</span>
                <span class="kc">None</span>
            <span class="p">)</span>


        <span class="n">fname_substitutions</span> <span class="o">=</span> <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span>
        <span class="p">)</span>
        <span class="n">image_slice_list</span> <span class="o">=</span> <span class="n">get_image_slices</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">split_image</span><span class="p">,</span>
                                            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">discard_image_boundary</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">get_3d_image_slice_fname</span><span class="p">(</span><span class="o">*</span><span class="n">image_slice</span><span class="p">,</span> <span class="n">fname_substitutions</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">image_slice</span> <span class="ow">in</span> <span class="n">image_slice_list</span><span class="p">],</span>
            <span class="p">(</span>
                <span class="kc">None</span> <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span>
                <span class="k">else</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_3d_spline_plot</span> <span class="o">%</span> <span class="n">fname_substitutions</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">allow_existing_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span>
                           <span class="ow">or</span>
                           <span class="n">cmdline_args</span><span class="o">.</span><span class="n">skip_existing_plots</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">slice_fnames</span><span class="p">,</span> <span class="n">combined_fname</span> <span class="ow">in</span> <span class="n">get_3d_plot_tasks</span><span class="p">(</span>
            <span class="n">cmdline_args</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="n">combined_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span>
                <span class="n">prepare_file_output</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">,</span>
                                    <span class="n">allow_existing_plot</span><span class="p">,</span>
                                    <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_y_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_y_range</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span>
                <span class="n">spline</span><span class="p">,</span>
                <span class="n">individual_fname</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">prf_slice_splines</span><span class="p">,</span>
            <span class="n">slice_fnames</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">individual_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span>
                    <span class="n">prepare_file_output</span><span class="p">(</span><span class="n">individual_fname</span><span class="p">,</span>
                                        <span class="n">allow_existing_plot</span><span class="p">,</span>
                                        <span class="kc">True</span><span class="p">,</span>
                                        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">plot_3d_slice</span><span class="p">(</span>
                <span class="n">spline</span><span class="p">,</span>
                <span class="n">meshgrid_x</span><span class="p">,</span>
                <span class="n">meshgrid_y</span><span class="p">,</span>
                <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_3d_spline_contour_stride</span><span class="p">,</span>
                <span class="n">linewidths</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_3d_spline_contour_linewidths</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">individual_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">individual_fname</span><span class="p">,</span>
                                   <span class="n">dpi</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">figure_dpi</span><span class="p">)</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">combined_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">,</span>
                           <span class="n">dpi</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">figure_dpi</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_image_slices">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_image_slices">[docs]</a>
<span class="k">def</span> <span class="nf">get_image_slices</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">inner_only</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return [(x-slice, y-slice, x_index, y_index), ...] per `--split-image` arg.</span>

<span class="sd">    Args:</span>
<span class="sd">        splits:    The parsed image splits directly from the command line.</span>

<span class="sd">        inner_only(bool):    If True, slices in contact with the outer border</span>
<span class="sd">            of the image are discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [(x-slice, y-slice, x_index, y_index), ...]:</span>
<span class="sd">            Array slices directly useable to index the image implementing the</span>
<span class="sd">            splitting specified on the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">split_slices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]}</span>

    <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
        <span class="n">split_slices</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">split_slices</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                            <span class="n">value</span><span class="p">)</span>
        <span class="n">split_slices</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">inner_only</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="n">split_slices</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_slices</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Split slices: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">split_slices</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">x_split</span><span class="p">,</span> <span class="n">y_split</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">x_split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_slices</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">y_split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_slices</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="p">]</span></div>



<div class="viewcode-block" id="AlglibSpline">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.AlglibSpline">[docs]</a>
<span class="k">class</span> <span class="nc">AlglibSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap alglib based splines so they can be evaluated on scipy arrays.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AlglibSpline.__init__">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.AlglibSpline.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prf_data</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">penalty</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the spline on the given data.</span>

<span class="sd">        Args:</span>
<span class="sd">            prf_data:    The return value of get_prf_data().</span>

<span class="sd">            resolution(int, int):    The grid resolution to use when building</span>
<span class="sd">                the spline.</span>

<span class="sd">            penalty(float):    The nonlinearity penalty when fitting the spline.</span>

<span class="sd">            domain(float, float, float, float):    The area (xmin, xmax, ymin,</span>
<span class="sd">                ymax) over which the spline will be derived.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dbuildercreate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dbuildersetpoints</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span>
                                         <span class="n">prf_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                                         <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dbuildersetgrid</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="o">*</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dbuildersetarea</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="o">*</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dbuildersetalgoblocklls</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">penalty</span><span class="p">)</span>

        <span class="n">spline</span> <span class="o">=</span> <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dfit</span><span class="p">(</span><span class="n">builder</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ny_nodes</span><span class="p">,</span> <span class="n">nx_nodes</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">coef_table</span> <span class="o">=</span> <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dunpackv</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">nvals</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_nodes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="o">+</span>
            <span class="p">[</span><span class="n">coef_table</span><span class="p">[</span><span class="n">nx_nodes</span> <span class="o">-</span> <span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_nodes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">nx_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="o">+</span>
            <span class="p">[</span><span class="n">coef_table</span><span class="p">[(</span><span class="n">ny_nodes</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nx_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">3</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spline_eval</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">xalglib</span><span class="o">.</span><span class="n">spline2dcalc</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AlglibSpline.__call__">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.AlglibSpline.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the spline.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlglibSpline.plot_grid_boundaries">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.AlglibSpline.plot_grid_boundaries">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_grid_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add vertical lines to the current axis showing the grid along direction.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction(str):    Either `&#39;x&#39;`, or `&#39;y&#39;`, selecting which direction</span>
<span class="sd">                to show the grid lines along.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;_nodes&#39;</span><span class="p">):</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span></div>
</div>



<span class="c1">#TODO: simplify later</span>
<span class="c1">#pylint: disable=too-many-locals</span>
<div class="viewcode-block" id="pad_prf_data">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.pad_prf_data">[docs]</a>
<span class="k">def</span> <span class="nf">pad_prf_data</span><span class="p">(</span><span class="n">prf_data</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return PRF data zero-padded for fitting and the spline fit domain.&quot;&quot;&quot;</span>

    <span class="c1">#False positive</span>
    <span class="c1">#pylint: disable=assignment-from-no-return</span>
    <span class="n">keep_prf_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1">#pylint: enable=assignment-from-no-return</span>
    <span class="n">num_keep</span> <span class="o">=</span> <span class="n">keep_prf_data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">x_padding</span> <span class="o">=</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_fraction</span>
    <span class="n">y_padding</span> <span class="o">=</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_fraction</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_padding</span><span class="p">,</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_padding</span><span class="p">,</span>
        <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_padding</span><span class="p">,</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_padding</span>
    <span class="p">)</span>
    <span class="n">middle_npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span>
                         <span class="o">/</span>
                         <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_fraction</span><span class="p">)</span>
    <span class="n">padded_prf_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">num_keep</span>
                <span class="o">+</span>
                <span class="mi">4</span>
                <span class="o">*</span>
                <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span>
                <span class="o">*</span>
                <span class="p">(</span>
                    <span class="n">middle_npoints</span>
                    <span class="o">+</span>
                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
    <span class="p">)</span>
    <span class="n">padded_prf_data</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">num_keep</span><span class="p">]</span> <span class="o">=</span> <span class="n">prf_data</span><span class="p">[:,</span> <span class="n">keep_prf_data</span><span class="p">]</span>
    <span class="n">padded_prf_data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_keep</span> <span class="p">:</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">padded_prf_data</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_keep</span> <span class="p">:</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">prf_data</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">keep_prf_data</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="o">/</span>
        <span class="n">num_keep</span>
    <span class="p">)</span>
    <span class="n">xy_padding_start</span> <span class="o">=</span> <span class="n">num_keep</span>
    <span class="n">corner_x</span><span class="p">,</span> <span class="n">corner_y</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_padding</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span><span class="p">),</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_padding</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">mid_x_x</span><span class="p">,</span> <span class="n">mid_x_y</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">middle_npoints</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">y_padding</span><span class="p">,</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">mid_y_x</span><span class="p">,</span> <span class="n">mid_y_y</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">x_padding</span><span class="p">,</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_pad_npoints</span>
        <span class="p">),</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="o">-</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">middle_npoints</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">corner_x</span> <span class="o">=</span> <span class="n">corner_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">corner_y</span> <span class="o">=</span> <span class="n">corner_y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mid_x_x</span> <span class="o">=</span> <span class="n">mid_x_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mid_x_y</span> <span class="o">=</span> <span class="n">mid_x_y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mid_y_x</span> <span class="o">=</span> <span class="n">mid_y_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mid_y_y</span> <span class="o">=</span> <span class="n">mid_y_y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">add_mid_x</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">x_offset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_padding</span><span class="p">]:</span>
        <span class="n">padded_prf_data</span><span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">mid_y_x</span><span class="o">.</span><span class="n">size</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">mid_y_x</span> <span class="o">+</span> <span class="n">x_offset</span>
        <span class="n">padded_prf_data</span><span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">mid_y_x</span><span class="o">.</span><span class="n">size</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">mid_y_y</span>
        <span class="n">xy_padding_start</span> <span class="o">+=</span> <span class="n">mid_y_x</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_padding</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">add_mid_x</span><span class="p">:</span>
                <span class="n">padded_prf_data</span><span class="p">[</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">mid_x_x</span><span class="o">.</span><span class="n">size</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">mid_x_x</span>
                <span class="n">padded_prf_data</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">mid_x_x</span><span class="o">.</span><span class="n">size</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">mid_x_y</span> <span class="o">+</span> <span class="n">y_offset</span>
                <span class="n">xy_padding_start</span> <span class="o">+=</span> <span class="n">mid_x_x</span><span class="o">.</span><span class="n">size</span>
            <span class="n">padded_prf_data</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">corner_x</span><span class="o">.</span><span class="n">size</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">corner_x</span> <span class="o">+</span> <span class="n">x_offset</span>
            <span class="n">padded_prf_data</span><span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">xy_padding_start</span><span class="p">:</span> <span class="n">xy_padding_start</span> <span class="o">+</span> <span class="n">corner_x</span><span class="o">.</span><span class="n">size</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">corner_y</span> <span class="o">+</span> <span class="n">y_offset</span>
            <span class="n">xy_padding_start</span> <span class="o">+=</span> <span class="n">corner_x</span><span class="o">.</span><span class="n">size</span>
        <span class="n">add_mid_x</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">padded_prf_data</span><span class="p">,</span> <span class="n">domain</span></div>

<span class="c1">#pylint: enable=too-many-locals</span>


<div class="viewcode-block" id="fit_spline">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.fit_spline">[docs]</a>
<span class="k">def</span> <span class="nf">fit_spline</span><span class="p">(</span><span class="n">prf_data</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the best-fit spline to the PRF per the command line config.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_method</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_method</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SmoothBivariateSpline</span><span class="p">(</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">prf_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_smoothing</span> <span class="o">*</span> <span class="n">prf_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">domain</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">AlglibSpline</span><span class="p">(</span>
        <span class="n">prf_data</span><span class="p">,</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_resolution</span><span class="p">,</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">spline_smoothing</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_plot_tasks">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.get_plot_tasks">[docs]</a>
<span class="k">def</span> <span class="nf">get_plot_tasks</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator for all the plots that must be created.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmdline_args:    The parse command line configuration.</span>

<span class="sd">    Yields:</span>
<span class="sd">        dict: The parsed PRF slice directly taken from the command line to plot</span>

<span class="sd">        [(str on None), ...]: List of the filenames to save the plot if each</span>
<span class="sd">            slice is saved separately. Appropriate length of Nones otherwise.</span>

<span class="sd">        str or None: The filanem to save a combined plot of all pieces of the</span>
<span class="sd">           image together or None if individual images are saved separately.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_image_slice_fname</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">,</span>
                              <span class="n">y_image_slice</span><span class="p">,</span>
                              <span class="n">x_index</span><span class="p">,</span>
                              <span class="n">y_index</span><span class="p">,</span>
                              <span class="n">fname_substitutions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a single ently of the plotting tasks per image silce.&quot;&quot;&quot;</span>

        <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;XSPLIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_index</span><span class="p">)</span>
                                         <span class="k">if</span> <span class="n">x_image_slice</span> <span class="k">else</span>
                                         <span class="kc">None</span><span class="p">)</span>
        <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;YSPLIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_image_slice</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_index</span><span class="p">)</span>
                                         <span class="k">if</span> <span class="n">y_image_slice</span> <span class="k">else</span>
                                         <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_plot_pattern</span> <span class="o">%</span> <span class="n">fname_substitutions</span>
            <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span> <span class="k">else</span>
            <span class="kc">None</span>
        <span class="p">)</span>

    <span class="n">fname_substitutions</span> <span class="o">=</span> <span class="n">get_fname_pattern_substitutions</span><span class="p">(</span>
        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span>
    <span class="p">)</span>
    <span class="n">image_slice_list</span> <span class="o">=</span> <span class="n">get_image_slices</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">split_image</span><span class="p">,</span>
                                        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">discard_image_boundary</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">plot_slice</span> <span class="ow">in</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">slice</span><span class="p">:</span>
        <span class="n">slice_direction</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="k">if</span> <span class="s1">&#39;x_offset&#39;</span> <span class="ow">in</span> <span class="n">plot_slice</span> <span class="k">else</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;SLICEDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_direction</span>
        <span class="n">fname_substitutions</span><span class="p">[</span><span class="s1">&#39;SLICEOFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_slice</span><span class="p">[</span><span class="n">slice_direction</span>
                                                        <span class="o">+</span>
                                                        <span class="s1">&#39;_offset&#39;</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">plot_slice</span><span class="p">,</span>
            <span class="p">[</span><span class="n">get_image_slice_fname</span><span class="p">(</span><span class="o">*</span><span class="n">image_slice</span><span class="p">,</span> <span class="n">fname_substitutions</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">image_slice</span> <span class="ow">in</span> <span class="n">image_slice_list</span><span class="p">],</span>
            <span class="p">(</span>
                <span class="kc">None</span> <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span>
                <span class="k">else</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_plot_pattern</span> <span class="o">%</span> <span class="n">fname_substitutions</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="list_plot_filenames">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.list_plot_filenames">[docs]</a>
<span class="k">def</span> <span class="nf">list_plot_filenames</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List the filenames of all the plots that will be generated.&quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">save_plot_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">get_plot_tasks</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">)]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">slice_fnames</span><span class="p">,</span> <span class="n">outer_plot_fname</span> <span class="ow">in</span> <span class="n">get_plot_tasks</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">outer_plot_fname</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slice_fnames</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1">#TODO: see if it can be simplified</span>
<span class="c1">#pylint: disable=too-many-branches</span>
<div class="viewcode-block" id="show_plots">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.show_plots">[docs]</a>
<span class="k">def</span> <span class="nf">show_plots</span><span class="p">(</span><span class="n">slice_prf_data</span><span class="p">,</span> <span class="n">slice_splines</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the plots and display them to the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_prf_data(iterable):    List of the result of either get_prf_data()</span>
<span class="sd">            or pad_prf_data() for each image slice.</span>

<span class="sd">        slice_splines(iterable):    List of best-fit splines to the data for</span>
<span class="sd">            each image slice. Must support evaluation using arrays of x &amp; y</span>
<span class="sd">            positions.</span>

<span class="sd">        cmdline_args:    The parsed command line arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">allow_existing_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span>
                           <span class="ow">or</span>
                           <span class="n">cmdline_args</span><span class="o">.</span><span class="n">skip_existing_plots</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">plot_slice</span><span class="p">,</span> <span class="n">slice_fnames</span><span class="p">,</span> <span class="n">combined_fname</span> <span class="ow">in</span> <span class="n">get_plot_tasks</span><span class="p">(</span>
            <span class="n">cmdline_args</span>
    <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_slice: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">plot_slice</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Slice filenames: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">slice_fnames</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combined_fname: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="n">combined_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span>
                <span class="n">prepare_file_output</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">,</span>
                                    <span class="n">allow_existing_plot</span><span class="p">,</span>
                                    <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_y_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_y_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_fnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">slice_fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slice_fnames</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_prf_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prf_data</span><span class="p">,</span> <span class="n">label</span><span class="p">),</span>
                <span class="n">spline</span><span class="p">,</span>
                <span class="n">individual_fname</span><span class="p">,</span>
                <span class="n">color</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">slice_prf_data</span><span class="p">,</span>
            <span class="n">slice_splines</span><span class="p">,</span>
            <span class="n">slice_fnames</span><span class="p">,</span>
            <span class="n">kelly_colors</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">individual_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span>
                    <span class="n">prepare_file_output</span><span class="p">(</span><span class="n">individual_fname</span><span class="p">,</span>
                                        <span class="n">allow_existing_plot</span><span class="p">,</span>
                                        <span class="kc">True</span><span class="p">,</span>
                                        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">overwrite_plots</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">plot_prf_slice</span><span class="p">(</span>
                <span class="n">prf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">spline</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="n">label</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">error_scale</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">error_scale</span><span class="p">,</span>
                <span class="n">points_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">marker_size</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">marker_size</span><span class="p">,</span>
                <span class="o">**</span><span class="n">plot_slice</span><span class="p">,</span>
                <span class="o">**</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">add_binned</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spline</span><span class="o">.</span><span class="n">plot_grid_boundaries</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="k">if</span> <span class="s1">&#39;y_offset&#39;</span> <span class="ow">in</span> <span class="n">plot_slice</span> <span class="k">else</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">append</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;pixel center - source center [pix]&#39;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;normalized pixel response&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">individual_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">individual_fname</span><span class="p">,</span>
                                   <span class="n">dpi</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">figure_dpi</span><span class="p">)</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">plot_multi_image</span> <span class="ow">or</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">))</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;pixel center - source center [pix]&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;normalized pixel response&#39;</span><span class="p">)</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">combined_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">combined_fname</span><span class="p">,</span>
                           <span class="n">dpi</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">figure_dpi</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span></div>

<span class="c1">#pylint: enable=too-many-branches</span>


<div class="viewcode-block" id="extract_pixel_data">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.extract_pixel_data">[docs]</a>
<span class="k">def</span> <span class="nf">extract_pixel_data</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">,</span> <span class="n">image_slices</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the pixel level data from the input image required for the plot.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmdline_args:    The parsed command line arguments.</span>

<span class="sd">        image_slices:    How to split the image when plotting (the return value</span>
<span class="sd">            of get_image_slices()).</span>

<span class="sd">        sources(scipy.array or None):    If not None, it should be an array with</span>
<span class="sd">            equivalent structure to get_source_info(). If None,</span>
<span class="sd">            get_source_info() is used to initialize it.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List:</span>
<span class="sd">            A list of the PRF data (see return of get_prf_data()) for each</span>
<span class="sd">            image slice each entry contains the data and a plot label.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">frame</span><span class="p">:</span>
        <span class="c1">#False positive</span>
        <span class="c1">#pylint: disable=no-member</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]:</span>
            <span class="n">image_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span>
                                <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
            <span class="n">first_hdu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span>
                                <span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
            <span class="n">first_hdu</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">assert</span> <span class="n">image_resolution</span> <span class="o">==</span> <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans_fname</span> <span class="o">=</span> <span class="n">get_trans_fname</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">frame_fname</span><span class="p">,</span>
                                          <span class="n">cmdline_args</span><span class="o">.</span><span class="n">trans_pattern</span><span class="p">)</span>
            <span class="c1">#pylint: enable=no-member</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">get_source_info</span><span class="p">(</span>
                <span class="n">pixel_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                <span class="n">stddev_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                <span class="n">mask_array</span><span class="o">=</span><span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">c_char</span><span class="p">),</span>
                <span class="n">source_positions</span><span class="o">=</span><span class="n">get_source_positions</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">catalogue</span><span class="p">,</span>
                                                      <span class="n">trans_fname</span><span class="p">,</span>
                                                      <span class="n">image_resolution</span><span class="p">),</span>
                <span class="n">aperture</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">flux_aperture</span><span class="p">,</span>
                <span class="n">bg_radii</span><span class="o">=</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">background_annulus</span>
            <span class="p">)</span>
            <span class="c1">#pylint: disable=no-member</span>

        <span class="n">pixel_offsets</span> <span class="o">=</span> <span class="n">find_pixel_offsets</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                                           <span class="n">cmdline_args</span><span class="o">.</span><span class="n">prf_range</span><span class="p">,</span>
                                           <span class="n">image_resolution</span><span class="p">,</span>
                                           <span class="mf">2.0</span> <span class="o">*</span> <span class="n">cmdline_args</span><span class="o">.</span><span class="n">flux_aperture</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">pad_prf_data</span><span class="p">(</span>
                    <span class="n">get_prf_data</span><span class="p">(</span>
                        <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
                        <span class="n">frame</span><span class="p">[</span><span class="n">first_hdu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
                        <span class="n">pixel_offsets</span><span class="p">[</span><span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_image_slice</span><span class="p">],</span>
                        <span class="n">cmdline_args</span><span class="o">.</span><span class="n">error_threshold</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">cmdline_args</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="c1">#This is more readable</span>
                    <span class="c1">#pylint: disable=consider-using-f-string</span>
                    <span class="s1">&#39;(</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)&#39;</span>
                    <span class="o">%</span>
                    <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">x_image_slice</span><span class="o">.</span><span class="n">start</span>
                            <span class="o">+</span>
                            <span class="p">(</span><span class="n">x_image_slice</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">image_resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="n">y_image_slice</span><span class="o">.</span><span class="n">start</span>
                            <span class="o">+</span>
                            <span class="p">(</span><span class="n">y_image_slice</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">image_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="p">)</span>
                    <span class="c1">#pylint: enable=consider-using-f-string</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x_image_slice</span><span class="p">,</span> <span class="n">y_image_slice</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span> <span class="ow">in</span> <span class="n">image_slices</span>
        <span class="p">]</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../_implementation/astrowisp.utils.explore_prf.html#astrowisp.utils.explore_prf.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Avoid polluting global namespace.&quot;&quot;&quot;</span>

    <span class="n">image_slices</span> <span class="o">=</span> <span class="n">get_image_slices</span><span class="p">(</span><span class="n">cmdline_args</span><span class="o">.</span><span class="n">split_image</span><span class="p">,</span>
                                    <span class="n">cmdline_args</span><span class="o">.</span><span class="n">discard_image_boundary</span><span class="p">)</span>
    <span class="n">slice_prf_data</span> <span class="o">=</span> <span class="n">extract_pixel_data</span><span class="p">(</span><span class="n">cmdline_args</span><span class="p">,</span> <span class="n">image_slices</span><span class="p">)</span>
    <span class="n">slice_splines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fit_spline</span><span class="p">(</span><span class="n">prf_data</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">cmdline_args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prf_data</span><span class="p">,</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">slice_prf_data</span>
    <span class="p">]</span>

    <span class="n">show_plots</span><span class="p">(</span><span class="n">slice_prf_data</span><span class="p">,</span>
               <span class="n">slice_splines</span><span class="p">,</span>
               <span class="n">cmdline_args</span><span class="p">)</span></div>


    <span class="c1">#TODO fix this to, broken atm fix sources</span>

    <span class="c1"># if cmdline_args.plot_entire_prf:</span>
    <span class="c1">#     plot_entire_prf(cmdline_args,</span>
    <span class="c1">#                     image_slices,</span>
    <span class="c1">#                     sources=None)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">parse_command_line</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Kaloyan Penev.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>