<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sub-Pixel Photometry: Integrals of the PSF</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sub-Pixel Photometry
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('PSF_integrals_page.xhtml',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Integrals of the PSF </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_PSFIntegrals"></a></p>
<p>In this package, integrals of the PSF are performed by using a local polynomial approximation:</p>
<p class="formulaDsp">
\[ \int dy \int dx PSF(x_0+x, y_0+y) dx dy \approx \int dy \int dx \sum_{m=0}^{m=M} \sum_{n=0}^{n=N} f_{m,n} x^m y^n \]
</p>
<p> where \(f_{m,n}\) could, but need not be the taylor expansion coefficients around \((x_0, y_0)\).</p>
<p>As a result, all that is necessary is calculating integrals of \(x^my^n\) for non-negative integer \(m\) and \(n\).</p>
<p>PSF fitting and aperture photometry, correcting for the subpixel structure requires calculating the integral of the PSF over rectangles and over pieces of a circle.</p>
<h1>Integrating rectangles </h1>
<p>It is necessary to calculate integrals over rectangles defined as follows: <img src="rectangle.png" alt="" class="inline" title="Aperture photometry and PSF fitting need to calculate integrals over the shaded rectangle."/>   </p>
<p>The integral over a rectangle is obviously given by: </p><p class="formulaDsp">
\begin{equation} I^{rect}_{m,n}\equiv \int_{-\Delta y}^{\Delta y} dy \int_{-\Delta x}^{\Delta x} dx x^m y^n = \left\{ \begin{array}{l@{\quad}l} 0 &amp; \mathrm{if}\ m\ \mathrm{is\ odd\ or}\ n\ \mathrm{is\ odd}\\ \frac{4\Delta x^{m+1} \Delta y^{n+1}}{(m+1)(n+1)} &amp; \mathrm{otherwise} \end{array} \right. \end{equation}
</p>
<h1>Integrating circle wedges </h1>
<p><img src="circle_wedge.png" alt="" class="inline" title="We need to calculate integrals of the PSF over the shaded piece of the circle with x and y relative to the point (x_0, y_0)."/>   </p>
<p>Since we are using a local polynomial approximation only the following integral needs to be computed:</p>
<p class="formulaDsp">
\begin{equation} I^{circ}_{m,n}\equiv \int_{-\Delta y}^{\Delta y} dy \int_{-\Delta x}^{\sqrt{r^2-y_0^2-y^2-2y_0y}-x_0} dx x^m y^n \end{equation}
</p>
<h2>The solution:</h2>
<p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\Bigg\{ \sum_{i=0}^{m+1} \binom{m+1}{i} Q_{i,n} (-x_0)^{m+1-i} \nonumber\\&amp;&amp;{}+ (-1)^m\frac{\Delta x^{m+1} \Delta y^{n+1}}{n+1}\left[1+(-1)^n\right] \Bigg\}\\ Q_{m,n} &amp;=&amp; (r^2-y_0^2)Q_{m-2,n} - 2y_0Q_{m-2,n+1} - Q_{m-2,n+2}\\ Q_{0,n}=P_n^{even} &amp;=&amp;\frac{2}{n+1}\left\{ \begin{array}{ll} 0 &amp;, \quad n-\mathrm{odd}\\ \Delta y^{n+1} &amp;, \quad n-\mathrm{even}\\ \end{array} \right.\\ Q_{1,n}=P_n^{odd}&amp;=&amp; \frac{n-1}{n+2}(r^2-y_0^2)P_{n-2}^{odd} - \frac{2n+1}{n+2}y_0P_{n-1}^{odd}+\nonumber\\ &amp;&amp;{}+\frac{2\Delta y^{n-1}}{n+2}\times \left\{\begin{array}{l@{,}l} -x_0^3-3x_0\Delta x^2 &amp; \quad n-\mathrm{even}\\ 3x_0^2\Delta x + \Delta x^3 &amp; \quad n-\mathrm{odd}\\ \end{array}\right.\\ P_0^{odd} &amp;=&amp; \frac{1}{2}\left[ (y_0+\Delta y)(x_0-\Delta x) - (y_0-\Delta y)(x_0+\Delta x) \right]\nonumber\\ &amp;&amp;{}+ \frac{r^2}{2}\left[ \tan^{-1} \frac{x_0+\Delta x}{y_0-\Delta y} - \tan^{-1} \frac{x_0-\Delta x}{y_0+\Delta y} \right]\\ P_1^{odd} &amp;=&amp; \frac{y_0}{2}\left[ (x_0+\Delta x)(y_0-\Delta y) - (x_0-\Delta x)(y_0+\Delta y) \right]\nonumber\\ &amp;&amp;{}+ \frac{(x_0+\Delta x)^3 - (x_0-\Delta x)^3}{3}\nonumber\\ &amp;&amp;{}- \frac{1}{2} y_0r^2 \left( \tan^{-1} \frac{x_0+\Delta x}{y_0 - \Delta y} - \tan^{-1} \frac{x_0-\Delta x}{y_0 + \Delta y} \right) \end{eqnarray}
</p>
<h2>Derivation of the solution:</h2>
<p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\int_{-\Delta y}^{\Delta y} dy y^n\left[(\sqrt{r^2-y_0^2-y^2-2y_0y}-x_0)^{m+1} - (-\Delta x)^{m+1}\right]\nonumber\\ &amp;=&amp; \frac{1}{m+1}\Bigg\{ \sum_{i=0}^{m+1} \binom{m+1}{i} Q_{i,n} (-x_0)^{m+1-i} \nonumber\\&amp;&amp;{}+ (-1)^m\frac{\Delta x^{m+1} \Delta y^{n+1}}{n+1}\left[1+(-1)^n\right] \Bigg\} \end{eqnarray}
</p>
<p> Where: </p><p class="formulaDsp">
\begin{equation} Q_{m,n}\equiv \int_{-\Delta y}^{\Delta y} y^n (r^2-y_0^2-y^2-2y_0y)^{m/2} dy \end{equation}
</p>
<p>The \(Q_{m,n}\) quantities clearly obey the following recursion relation: </p><p class="formulaDsp">
\begin{equation} Q_{m,n}=(r^2-y_0^2)Q_{m-2,n} - 2y_0Q_{m-2,n+1} - Q_{m-2,n+2} \end{equation}
</p>
<p>So a general solution only requires us to be able to calculate \(Q_{0,n}\) and \(Q_{1,n}\).</p>
<p>\(Q_{0,n}\) is easy: </p><p class="formulaDsp">
\begin{eqnarray} Q_{0,n}=P_n^{even}&amp;=&amp; \int_{-\Delta y}^{\Delta y} y^n dy\\ &amp;=&amp;\frac{2}{n+1}\left\{ \begin{array}{ll} 0 &amp;, \quad n-\mathrm{odd}\\ \Delta y^{n+1} &amp;, \quad n-\mathrm{even}\\ \end{array} \right. \end{eqnarray}
</p>
<p class="formulaDsp">
\begin{equation} Q_{1,n}=P_n^{odd}= \int_{-\Delta y}^{\Delta y} y^n \sqrt{r^2-y_0^2-y^2-2y_0y} dy\\ \end{equation}
</p>
<p>Consider the following combination: </p><p class="formulaDsp">
\begin{eqnarray*} y_0 P_{n-1}^{odd} + P_n^{odd} &amp;=&amp; \frac{1}{2} \int y^{n-1}2(y_0+y)\sqrt{r^2-y_0^2-y^2-2y_0y} dy\\ &amp;=&amp; -\frac{1}{2} \int y^{n-1}\sqrt{r^2-y_0^2-y^2-2y_0y} d(r^2-y_0^2-y^2-2y_0y)\\ &amp;=&amp; -\frac{1}{3} \int y^{n-1}d(r^2-y_0^2-y^2-2y_0y)^{3/2}\\ &amp;=&amp; -\frac{1}{3} \left[y^{n-1}\Lambda(y)\right]_{-\Delta y}^{\Delta y} +\frac{n-1}{3} \int y^{n-2}(r^2-y_0^2-y^2-2y_0y)^{3/2}dy\\ &amp;=&amp; -\frac{1}{3} \Delta y^{n-1}\left[\Lambda(\Delta y) + (-1)^n \Lambda(-\Delta y)\right] +\frac{n-1}{3} \left[ (r^2-y_0^2)P_{n-2}^{odd} - P_n^{odd} - 2y_0P_{n-1}^{odd} \right]\\ \Rightarrow (n+2)P_{n}^{odd} &amp;=&amp; -\Delta y^{n-1}\left[\Lambda^3(\Delta y) + (-1)^n \Lambda^3(-\Delta y)\right] + (n-1)(r^2-y_0^2)P_{n-2}^{odd} - (2n+1)y_0P_{n-1}^{odd} \end{eqnarray*}
</p>
<p>Where \(\Lambda(y)\equiv \sqrt{r^2-y_0^2-y^2-2y_0y}\).</p>
<p>So finally all we need is \(P_0^{odd}\) and \(P_1^{odd}\). From an online integrals table:</p>
<p class="formulaDsp">
\[ \int \sqrt{a x^2 + b x + c}\ dx = \frac{b+2ax}{4a}\sqrt{ax^2+bx+c} + \frac{4ac-b^2}{8a^{3/2}}\ln \left| 2ax + b + 2\sqrt{a(ax^2+bx+c)}\right | \]
</p>
<p>Therefore: </p><p class="formulaDsp">
\begin{eqnarray*} P_0^{odd} &amp;=&amp; \int_{-\Delta y}^{\Delta y} \sqrt{r^2-y_0^2-y^2-2y_0y} dy\\ &amp;=&amp; \left\{\frac{y_0+y}{2}\sqrt{r^2-y_0^2-y^2-2y_0y} - \frac{i r^2}{2} \ln 2\left| y + y_0 - i\sqrt{r^2-y_0^2-y^2-2y_0y}\right| \right\}_{-\Delta y}^{\Delta y}\\ &amp;=&amp; \left\{\frac{y_0+y}{2}\sqrt{r^2-y_0^2-y^2-2y_0y} - \frac{i r^2}{2}\left[\ln 2 + \ln r - i \tan^{-1} \frac{\sqrt{r^2-y_0^2-y^2-2y_0y}}{y_0+y} \right] \right\}_{-\Delta y}^{\Delta y}\\ &amp;=&amp; \left[\frac{y_0+y}{2}\Lambda(y) - \frac{r^2}{2}\tan^{-1} \frac{\Lambda(y)}{y_0+y} \right]_{-\Delta y}^{\Delta y}\\ &amp;=&amp; \frac{y_0+\Delta y}{2}\Lambda(\Delta y) - \frac{y_0-\Delta y}{2}\Lambda(-\Delta y) +\frac{r^2}{2}\tan^{-1} \frac{\Lambda(-\Delta y)}{y_0-\Delta y} -\frac{r^2}{2}\tan^{-1} \frac{\Lambda(\Delta y)}{y_0+\Delta y} \end{eqnarray*}
</p>
<p>From the same online integral table: </p><p class="formulaDsp">
\begin{equation} \begin{split} \int &amp;x \sqrt{a x^2 + bx + c}\ dx = \frac{1}{48a^{5/2}}\left ( 2 \sqrt{a} \sqrt{ax^2+bx+c} \right . \left( - 3b^2 + 2 abx + 8 a(c+ax^2) \right) \\ &amp; \left. + 3(b^3-4abc)\ln \left|b + 2ax + 2\sqrt{a}\sqrt{ax^2+bx+c} \right| \right) \end{split} \end{equation}
</p>
<p>Therefore (dropping constants as we go): </p><p class="formulaDsp">
\begin{eqnarray*} P_1^{odd} &amp;=&amp; \int_{-\Delta y}^{\Delta y} y\sqrt{r^2-y_0^2-y^2-2y_0y} dy\\ &amp;=&amp; -\frac{i}{48}\Bigg\{ 2i\Lambda(y) \left[ -12y_0(y+y_0) - 8\Lambda^2(y)\right] - 24y_0r^2 \ln \left| y_0 + y - i\Lambda(y)\right| \Bigg\}_{-\Delta y}^{\Delta y}\\ &amp;=&amp; -\frac{i}{48}\Bigg\{ 2i\Lambda(y) \left[ -12y_0(y+y_0) - 8\Lambda^2(y)\right] + 24i y_0r^2 \tan^{-1} \frac{\Lambda(y)}{y_0 + y} \Bigg\}_{-\Delta y}^{\Delta y}\\ &amp;=&amp; \left\{ \frac{1}{2} y_0r^2 \tan^{-1} \frac{\Lambda(y)}{y_0 + y} -\frac{1}{6}\Lambda(y) \left[ 3y_0(y+y_0) + 2\Lambda^2(y)\right] \right\}_{-\Delta y}^{\Delta y} \end{eqnarray*}
</p>
<p>Finally, note that from the drawing \(\Lambda(\Delta y)=x-\Delta x\) and \(\Lambda(-\Delta y)=x+\Delta x\), so:</p>
<p class="formulaDsp">
\begin{eqnarray} P_n^{odd} &amp;=&amp; \frac{n-1}{n+2}(r^2-y_0^2)P_{n-2}^{even} - \frac{2n+1}{n+2}y_0P_{n-1}^{even}+\nonumber\\ &amp;&amp;{}+\frac{2\Delta y^{n-1}}{n+2}\times \left\{\begin{array}{l@{,}l} -x_0^3-3x_0\Delta x^2 &amp; \quad n-\mathrm{even}\\ 3x_0^2\Delta x + \Delta x^3 &amp; \quad n-\mathrm{odd}\\ \end{array}\right.\\ P_0^{odd} &amp;=&amp; \frac{1}{2}\left[ (y_0+\Delta y)(x-\Delta x) - (y_0-\Delta y)(x+\Delta y) \right]\nonumber\\ &amp;&amp;{}+ \frac{r^2}{2}\left[ \tan^{-1} \frac{x+\Delta x}{y_0-\Delta y} - \tan^{-1} \frac{x-\Delta x}{y_0+\Delta y} \right]\\ P_1^{odd} &amp;=&amp; \frac{y_0}{2}\left[ (x_0+\Delta x)(y_0-\Delta y) - (x_0-\Delta x)(y_0+\Delta y) \right]\nonumber\\ &amp;&amp;{}+ \frac{(x_0+\Delta x)^3 - (x_0-\Delta x)^3}{3}\nonumber\\ &amp;&amp;{}- \frac{1}{2} y_0r^2 \left( \tan^{-1} \frac{x_0+\Delta x}{y_0 - \Delta y} - \tan^{-1} \frac{x_0-\Delta x}{y_0 + \Delta y} \right) \end{eqnarray}
</p>
<h2>Checking the solution:</h2>
<p>Checking this solution is much uglier, so we will only check the terms with \(m+n&lt;=2\), since those we already have from the integrals local polynomial PSFs, which have been extensively debugged.</p>
<h3>m=n=0</h3>
<p>Extracting from the code: </p><p class="formulaDsp">
\begin{eqnarray*} I_{0,0}^{circ} &amp;=&amp; \frac{1}{2}\left[ r^2\gamma - 2(y_0-\Delta y)\Delta x - 2(x_0-\Delta x)\Delta y \right]\\ &amp;=&amp; \frac{r^2}{2}\gamma + 2 \Delta x \Delta y - y_0 \Delta x - x_0 \Delta y \end{eqnarray*}
</p>
<p> Where \(\gamma\equiv\tan^{-1} \frac{x_0+\Delta x}{y_0 - \Delta y} - \tan^{-1} \frac{x_0-\Delta x}{y_0 + \Delta y}\)</p>
<p>And from the solution: </p><p class="formulaDsp">
\begin{eqnarray*} I_{0,0}^{circ} &amp;=&amp; -x_0 Q_{0,0} + Q_{1,0} + 2 \Delta x \Delta y\\ &amp;=&amp; -2x_0\Delta y + \frac{1}{2}\left[ (y_0+\Delta y)(x_0-\Delta x) - (y_0-\Delta y)(x_0+\Delta x) \right] + \frac{r^2}{2}\gamma + 2\Delta x \Delta y\\ &amp;=&amp; -2x_0\Delta y + \frac{1}{2}\left[ x_0 y_0 - y_0\Delta x + x_0\Delta y - \Delta x \Delta y - x_0 y_0 - y_0\Delta x + x_0 \Delta y + \Delta x\Delta y \right] + 2\Delta x \Delta y + \frac{r^2}{2}\gamma\\ &amp;=&amp; -2 x_0\Delta y - y_0 \Delta x + x_0\Delta y + 2\Delta x \Delta y + \frac{r^2}{2}\gamma\\ &amp;=&amp; \frac{r^2}{2}\gamma + 2 \Delta x \Delta y - y_0 \Delta x - x_0 \Delta y \end{eqnarray*}
</p>
<h3>m=1, n=0</h3>
<p>Extracting from the code: </p><p class="formulaDsp">
\begin{eqnarray*} I_{1,0}^{circ} &amp;=&amp; -x_0\left[ \frac{r^2}{2}\gamma + 2\Delta x \Delta y - y_0\Delta x - x_0 \Delta y \right] + \frac{(y_0+\Delta y)^3-(y_0-\Delta y)^3}{3} - 2x_0\Delta x(y_0-\Delta y)\\ &amp;=&amp; -\frac{x_0 r^2}{2}\gamma -2 x_0 \Delta x\Delta y + x_0 y_0\Delta x + x_0^2\Delta y + \frac{y_0^3}{3} + y_0^2\Delta y + y_0 \Delta y^2 + \frac{\Delta y^3}{3} - \frac{y_0^3}{3} + y_0^2\Delta y - y_0\Delta y^2 + \frac{\Delta y^3}{3} - 2x_0y_0\Delta x + 2x_0\Delta x\Delta y\\ &amp;=&amp; -\frac{x_0r^2}{2}\gamma + x_0^2\Delta y + 2y_0^2\Delta y + \frac{2}{3}\Delta y^3 - x_0y_0\Delta x\\ &amp;=&amp; -\frac{x_0r^2}{2}\gamma + x_0^2\Delta y + x_0y_0\Delta x + \frac{2}{3}\Delta y^3\\ \end{eqnarray*}
</p>
<p> Where the last step uses \(x_0\Delta x=y_0\Delta y\).</p>
<p>From the solution: </p><p class="formulaDsp">
\begin{eqnarray*} I_{1,0}^{circ} &amp;=&amp; \frac{1}{2}\left\{ x_0^2Q_{0,0} - 2x_0Q_{1,0} + Q_{2,0} - 2\Delta x^2 \Delta y \right\}\\ &amp;=&amp; \frac{1}{2}\left\{ 2x_0^2\Delta y - x_0 \left[ (y_0+\Delta y)(x_0-\Delta x) - (y_0-\Delta y)(x_0+\Delta x) \right] - x_0r^2\gamma + Q_{2,0} - 2\Delta x^2 \Delta y \right\}\\ &amp;=&amp; \frac{1}{2}\left\{ 2x_0^2\Delta y - x_0(x_0 y_0 - y_0 \Delta x + x_0 \Delta y - \Delta x \Delta y -x_0 y_0 - y_0 \Delta x + x_0 \Delta y + \Delta x \Delta y) - x_0 r^2\gamma + 2 r^2 \Delta y - 2y_0^2\Delta y - \frac{2\Delta y^3}{3} - 2 \Delta x^2 \Delta y \right\}\\ &amp;=&amp; \frac{1}{2}\left\{ 2x_0^2\Delta y + 2 x_0 y_0 \Delta x - 2 x_0^2\Delta y - x_0r^2\gamma + 2r^2\Delta y - 2 y_0^2\Delta y - \frac{2\Delta y^3}{3} -2 \Delta x^2\Delta y \right\}\\ &amp;=&amp; x_0 y_0 \Delta x + (r^2-y_0^2)\Delta y - \frac{\Delta y^3}{3} - \Delta x^2 \Delta y - \frac{x_0 r^2}{2} \gamma\\ &amp;=&amp; x_0 y_0 \Delta x + (x_0^2 + \Delta x^2 + \Delta y^2)\Delta y - \frac{\Delta y^3}{3} - \Delta x^2 \Delta y - \frac{x_0 r^2}{2}\gamma\\ &amp;=&amp; x_0 y_0 \Delta x + x_0^2 \Delta y + \frac{2\Delta y^3}{3} - \frac{x_0 r^2}{2}\gamma \end{eqnarray*}
</p>
<p> Where the above uses: </p><p class="formulaDsp">
\begin{eqnarray*} Q_{2,0} &amp;=&amp; (r^2-y_0^2) Q_{0,0} - 2 y_0 Q_{0,1} - Q_{0,2} = 2(r^2-y_0^2)\Delta y - \frac{2\Delta y^3}{3}\\ r^2 &amp;=&amp; x_0^2 + y_0^2 + \Delta x^2 + \Delta y^2 \end{eqnarray*}
</p>
<h3>m=0, n=1</h3>
<p>Extracting from the code: </p><p class="formulaDsp">
\[ I_{1,0}^{circ} = -y_0\left[ \frac{r^2}{2}\gamma + 2\Delta x \Delta y - y_0\Delta x - x_0 \Delta y \right] + \frac{(x_0+\Delta x)^3-(x_0-\Delta x)^3}{3} - 2y_0\Delta y(x_0-\Delta x) \]
</p>
<p> Which is the same as \(I_{1,0}^{circ}\), but with ( \(x_0\), \(y_0\), \(\Delta x\), \(\Delta y\)) substituted with ( \(y_0\), \(x_0\), \(\Delta y\), \(\Delta x\)), so the final expression must be: </p><p class="formulaDsp">
\[ I_{1,0}^{circ} = -\frac{y_0r^2}{2}\gamma + y_0^2\Delta x + x_0y_0\Delta y + \frac{2}{3}\Delta x^3 \]
</p>
<p>From the solution: </p><p class="formulaDsp">
\begin{eqnarray*} I_{1,0}^{circ} &amp;=&amp; -x_0 Q_{0,1} + Q_{1,1} = Q_{1,1}\\ &amp;=&amp; \frac{y_0}{2}\left[ (x_0+\Delta x)(y_0-\Delta y) - (x_0-\Delta x)(y_0+\Delta y) \right] + \frac{(x_0+\Delta y)^3 - (x_0-\Delta x)^3}{3} - \frac{y_0 r^2}{2}\gamma\\ &amp;=&amp; \frac{y_0}{2} \left[ x_0 y_0 - x_0\Delta y + y_0 \Delta x - \Delta x\Delta y -x_0 y_0 - x_0\Delta y + y_0 \Delta x + \Delta x \Delta y \right] + \frac{x_0^3}{3} + x_0^2\Delta x + x_0\Delta x^2 + \frac{\Delta x^3}{3} - \frac{x_0^3}{3} + x_0^2\Delta x - x_0\Delta x^2 + \frac{\Delta x^3}{3} - \frac{y_0 r^2}{2}\gamma\\ &amp;=&amp; -x_0 y_0 \Delta y + y_0^2\Delta x + 2x_0^2\Delta x + \frac{2\Delta x^3}{3} - \frac{y_0 r^2}{2}\gamma\\ &amp;=&amp; y_0^2\Delta x + x_0 y_0 \Delta y + \frac{2\Delta x^3}{3} - \frac{y_0 r^2}{2}\gamma \end{eqnarray*}
</p>
<p>The (m, n)=(2, 0), (1, 1) and (0, 2) expressions contain way too many terms to handle manually, so I fed the to Mathematica which confirmed that they reproduce the expressions in the code.</p>
<h1>Piecewise PSF pieces </h1>
<p>The implementation of piecewise PSFs makes use of integrals over more general areas than those defined above. The task can be split into rectangle and wedge integrals, but with x and y defined relative to an arbitrary point.</p>
<p><img src="hcircle_piece_diagram.png" alt="" class="inline" title="Integrals of the PSF need to be calculated over the shaded piece of the circle."/>   </p>
<p>The integral we wish to compute is:</p>
<p class="formulaDsp">
\begin{equation} I^{circ}_{m,n}\equiv \int_{y_{min}}^{y_{max}} dy \int_{x_{min}}^{\sqrt{r^2-(y-y_c)^2}+x_c} dx x^m y^n \end{equation}
</p>
<h2>The solution:</h2>
<p class="formulaDsp">
\begin{eqnarray*} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\Bigg\{ \sum_{i=0}^{m+1} \binom{m+1}{i} Q_{i,n} x_c^{m+1-i} \nonumber\\&amp;&amp;{}- \frac{x_{min}^{m+1}(y_{max}^{n+1}-y_{min}^{n+1})}{n+1} \Bigg\}\\ Q_{m,n}&amp;=&amp;(r^2-y_c^2)Q_{m-2,n} + 2y_cQ_{m-2,n+1} - Q_{m-2,n+2}\\ Q_{0,n}=P_n^{even}&amp;=&amp; \frac{y_{max}^{n+1}-y_{min}^{n+1}}{n+1}\\ Q_{1,n}=P_n^{odd}&amp;=&amp; \frac{1}{n+2}\Big\{ R_n(y_{min})-R_n(y_{max}) + (2n+1)y_cP_{n-1}^{odd} + (n-1)(r^2-y_c^2)P_{n-2}^{odd} \Big\}\\ P_0^{odd}&amp;=&amp;\frac{1}{2} \sqrt{r^2-(y_c-y_{max})^2}(y_{max}-y_c) - \frac{1}{2} \sqrt{r^2-(y_c-y_{min})^2} (y_{min}-y_c) -\\ &amp;&amp; -\frac{1}{2} r^2 \left( \tan^{-1}\left[ \frac{y_c-y_{max}}{\sqrt{r^2-(y_c-y_{max})^2}} \right] -\tan^{-1}\left[ \frac{y_c-y_{min}}{\sqrt{r^2-(y_c-y_{min})^2}} \right] \right)\\ P_1^{odd}&amp;=&amp;-\frac{1}{6} \sqrt{r^2-(y_c-y_{max})^2} \left(2 r^2+y_c^2+y_c y_{max}-2 y_{max}^2\right)+\\ &amp;&amp;+\frac{1}{6} \sqrt{r^2-(y_c-y_{min})^2} \left(2 r^2+y_c^2+y_c y_{min}-2 y_{min}^2\right)-\\ &amp;&amp;- \frac{1}{2} r^2 y_c \left( \tan^{-1}\left[ \frac{y_c-y_{max}}{\sqrt{r^2-(y_c-y_{max})^2}} \right] - \tan^{-1}\left[ \frac{y_c-y_{min}}{\sqrt{r^2-(y_c-y_{min})^2}} \right] \right) \end{eqnarray*}
</p>
<h2>Derivation of the solution:</h2>
<p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\int_{y_{min}}^{y_{max}} dy y^n\left[(\sqrt{r^2-(y-y_c)^2}+x_c)^{m+1} - x_{min}^{m+1}\right]\nonumber\\ &amp;=&amp; \frac{1}{m+1}\Bigg\{ \sum_{i=0}^{m+1} \binom{m+1}{i} Q_{i,n} x_c^{m+1-i} \nonumber\\&amp;&amp;{}- \frac{x_{min}^{m+1}(y_{max}^{n+1}-y_{min}^{n+1})}{n+1} \Bigg\} \end{eqnarray}
</p>
<p> Where: </p><p class="formulaDsp">
\begin{equation} Q_{m,n}\equiv \int_{y_{min}}^{y_{max}} y^n \left[r^2-(y-y_c)^2\right]^{m/2} dy \end{equation}
</p>
<p>The \(Q_{m,n}\) quantities clearly obey the following recursion relation: </p><p class="formulaDsp">
\begin{equation} Q_{m,n}=(r^2-y_c^2)Q_{m-2,n} + 2y_cQ_{m-2,n+1} - Q_{m-2,n+2} \end{equation}
</p>
<p>Just as above: \(Q_{0,n}\) is easy: </p><p class="formulaDsp">
\begin{eqnarray} Q_{0,n}=P_n^{even}&amp;=&amp; \int_{y_{min}}^{y_{max}} y^n dy\\ &amp;=&amp;\frac{1}{n+1}\left[y_{max}^{n+1}-y_{min}^{n+1}\right] \end{eqnarray}
</p>
<p>And: </p><p class="formulaDsp">
\begin{equation} Q_{1,n}=P_n^{odd}= \int_{y_{min}}^{y_{max}} y^n \sqrt{r^2-(y-y_c)^2} dy\\ \end{equation}
</p>
<p class="formulaDsp">
\begin{eqnarray*} P_n^{odd} - y_cP_{n-1}^{odd} &amp;=&amp; \int_{y_{min}}^{y_{max}} (y-y_c)y^{n-1}\sqrt{r^2-(y-y_c)^2} d(y-y_c)\\ &amp;=&amp; \frac{1}{2}\int_{y_{min}}^{y_{max}} y^{n-1}\sqrt{r^2-(y-y_c)^2} d(y-y_c)^2\\ &amp;=&amp; -\frac{1}{3}\int_{y_{min}}^{y_{max}} y^{n-1} d[r^2-(y-y_c)^2]^{3/2}\\ &amp;=&amp; -\frac{1}{3}\left\{ y^{n-1}\left[r^2-(y-y_c)^2\right]^{3/2} \right\}_{y_{min}}^{y_{max}} + \frac{n-1}{3}\int_{y_{min}}^{y_{max}} y^{n-2} \left[r^2-(y-y_c)^2\right]^{3/2} dy\\ &amp;=&amp; -\frac{1}{3}\left\{ y^{n-1}\left[r^2-(y-y_c)^2\right]^{3/2} \right\}_{y_{min}}^{y_{max}} + \frac{n-1}{3}\left\{ (r^2-y_c^2)P_{n-2} + 2y_cP_{n-1} - P_n \right\} \end{eqnarray*}
</p>
<p> Letting \(R_n(y)\equiv\left\{ y^{n-1}\left[r^2-(y-y_c)^2\right]^{3/2} \right\}_{y_{min}}^{y_{max}}\): </p><p class="formulaDsp">
\[ (n+2)P_n^{odd} = -R_n(y) + (2n+1)y_cP_{n-1}^{odd} + (n-1)(r^2-y_c^2)P_{n-2}^{odd} \]
</p>
<p>Using Mathematica: </p><p class="formulaDsp">
\[ P_0^{odd}=\frac{1}{2} \sqrt{r^2-(y_c-y_{max})^2}(-y_c+y_{max}) + \frac{1}{2} \sqrt{r^2-(y_c-y_min)^2} (y_c-y_{min}) - \frac{1}{2} r^2 \left( \tan^{-1}\left[ \frac{y_c-y_{max}}{\sqrt{r^2-(y_c-y_{max})^2}} \right] -\text{ArcTan}\left[ \frac{y_c-y_{min}}{\sqrt{r^2-(y_c-y_{min})^2}} \right] \right) \]
</p>
<p class="formulaDsp">
\[ P_1^{odd}=-\frac{1}{6} \sqrt{r^2-(y_c-y_{max})^2} \left(2 r^2+y_c^2+y_c y_{max}-2 y_{max}^2\right) + \frac{1}{6} \sqrt{r^2-(y_c-y_{min})^2} \left(2 r^2+y_c^2+y_c y_{min}-2 y_{min}^2\right) - \frac{1}{2} r^2 y_c \left( \tan^{-1}\left[ \frac{y_c-y_{max}}{\sqrt{r^2-(y_c-y_{max})^2}} \right] - \tan^{-1}\left[ \frac{y_c-y_{min}}{\sqrt{r^2-(y_c-y_{min})^2}} \right] \right) \]
</p>
<p>The solution was checked by implementing it in Machematica and checknig \(P_n^{odd}\), \(Q_{m,n}\) and \(I_{m,n}^{circ}\) againts the actual integral expressions for a few m, and n values.</p>
<h1>Integrating <b>useless</b> circle pieces </h1>
<p>I derived the integral over the following area as well due to not thinking through what is actually needed:</p>
<p><img src="useless_circle_wedge.png" alt="" class="inline" title="We can calculate integrals of the PSF over the shaded piece of the circle."/>   </p>
<p>The integral we wish to compute is:</p>
<p class="formulaDsp">
\begin{equation} I^{circ}_{m,n}\equiv \int_{y_0}^{y_{max}} dy \int_{x_0}^{\sqrt{r^2-y^2}} dx x^m y^n \end{equation}
</p>
<p> where \(y_{max}\equiv\sqrt{r^2-x_0^2}\). Similarly we define \(x_{max}\equiv\sqrt{r^2-y_0^2}\).</p>
<h2>The solution:</h2>
<p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\left(Q_{m,n} - x_0^{m+1}P^{odd}_n \right)\\ Q_{2k+1,n} &amp;=&amp; \sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i P^{odd}_{n+2i}\\ P^{odd}_n &amp;=&amp; \frac{y_{max}^{n+1} - y_0^{n+1}}{n+1}\\ Q_{2k,n} &amp;=&amp; \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i P^{even}_{n+2i}\\ P^{even}_n &amp;=&amp; \frac{1}{n+2} \left(y_0^{n-1}x_{max}^3 - y_{max}^{n-1}x_0^3\right) + \frac{n-1}{n+2}r^2P^{even}_{n-2}\\ P^{even}_0 &amp;=&amp; \frac{1}{2}\left[y_{max}x_0 - y_0x_{max} + r^2\left(\tan^{-1}\frac{y_{max}}{x_0} - \tan^{-1}\frac{y_0}{x_{max}}\right) \right]\\ P^{even}_1 &amp;=&amp; \frac{1}{3}\left(x_{max}^3 - x_0^3\right) \end{eqnarray}
</p>
<p>The \(Q_{m,n}\) quantities satisfy the following identity: </p><p class="formulaDsp">
\[ Q_{m+2,n}=r^2 Q_{m,n}-Q_{m,n+2} \]
</p>
<p> See below for proof.</p>
<p>This allows the same solution to be written in a different form: </p><p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n} &amp;=&amp; \frac{1}{m+1}\left(Q_{m,n} - x_0^{m+1}P^{odd}_{n} \right)\\ Q_{m,n} &amp;=&amp; r^2 Q_{m-2,n}-Q_{m-2,n+2}\\ Q_{1,n} &amp;=&amp; r^2 P^{odd}_{n} - P^{odd}_{n+2}\\ Q_{0,n} &amp;=&amp; P^{even}_n\\ \end{eqnarray}
</p>
<p> Where \(P^{even}_n\) and \(P^{odd}_n\) are the same quantities as above.</p>
<h2>Derivation of the solution:</h2>
<p class="formulaDsp">
\begin{eqnarray} I^{circ}_{m,n}&amp;=&amp;\frac{1}{m+1}\int_{y_0}^{y_{max}} dy y^n \left[ (r^2-y^2)^{(m+1)/2} - x_0^{m+1}\right]\\ &amp;=&amp; \frac{1}{m+1}\left[Q_{m,n} - \frac{x_0^{m+1}}{n+1} \left(y_{max}^{n+1} - y_0^{n+1}\right)\right] \end{eqnarray}
</p>
<p> Where: </p><p class="formulaDsp">
\begin{equation} Q_{m,n}\equiv\int_{y_0}^{y_{max}} dy y^n (r^2-y^2)^{(m+1)/2} \end{equation}
</p>
<p>At this point we need to consider two separate cases.</p>
<h3>Case 1: \(m=2k+1\) with \(k \in \mathbb{Z}^+\)</h3>
<p class="formulaDsp">
\begin{eqnarray} Q_{2k+1,n} &amp;=&amp;\int_{y_0}^{y_{max}} y^n (r^2-y^2)^{k+1} dy\\ &amp;=&amp;\int_{y_0}^{y_{max}} y^n \sum_{i=0}^{k+1} r^{2(k+1-i)} (-1)^i y^{2i} dy \end{eqnarray}
</p>
<p> Which gives: </p><p class="formulaDsp">
\begin{equation} Q_{2k+1,n}=\sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i \frac{y_{max}^{n+2i+1} - y_0^{n+2i+1}}{n+2i+1} \end{equation}
</p>
<h3>Case 2: \(m=2k\) with \(k \in \mathbb{Z}^+\)</h3>
<p class="formulaDsp">
\begin{eqnarray} Q_{2k,n} &amp;=&amp;\int_{y_0}^{y_{max}} y^n (r^2-y^2)^k \sqrt{r^2-y^2} dy\\ &amp;=&amp;\int_{y_0}^{y_{max}} y^n \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} y^{2i}(-1)^i \sqrt{r^2-y^2}\\ &amp;=&amp;\sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i P^{even}_{n+2i} \end{eqnarray}
</p>
<p> With: </p><p class="formulaDsp">
\begin{equation} P^{even}_n\equiv\int_{y_0}^{y_{max}} y^n\sqrt{r^2-y^2} dy \end{equation}
</p>
<p class="formulaDsp">
\begin{eqnarray} P^{even}_n &amp;=&amp;\frac{1}{2} \int_{y_0}^{y_{max}} y^{n-1} \sqrt{r^2-y^2} dy^2\\ &amp;=&amp;-\frac{1}{3} \int_{y_0}^{y_{max}} y^{n-1} d(r^2-y^2)^{3/2}\\ &amp;=&amp;\frac{1}{3}\bigg\{ y_0^{n-1}x_{max}^3 - y_{max}^{n-1} x_0^3 + \nonumber\\ &amp;&amp;\quad\quad {}+(n-1)\int_{y_0}^{y_{max}} y^{n-2}(r^2-y^2)\sqrt{r^2-y^2}dy \bigg\}\\ &amp;=&amp;\frac{1}{3}\left\{ y_0^{n-1} x_{max}^3 - y_max^{n-1}x_0^3 + (n-1)r^2P^{even}_{n-2} - (n-1)P^{even}_n \right\} \end{eqnarray}
</p>
<p>So we end up with: </p><p class="formulaDsp">
\begin{equation} P^{even}_n=\frac{1}{n+2} \left(y_0^{n-1}x_{max}^3 - y_{max}^{n-1}x_0^3\right) + \frac{n-1}{n+2}r^2P^{even}_{n-2} \end{equation}
</p>
<p>So in order to be able to calculate any \(P^{even}_n\) we need \(P^{even}_0\) and \(P^{even}_1\): </p><p class="formulaDsp">
\begin{eqnarray} P^{even}_0 &amp;=&amp; \int_{y_0}^{y_{max}} \sqrt{r^2-y^2} dy \\ &amp;=&amp; \frac{1}{2}\left[y_{max}x_0 - y_0x_{max} + r^2\left(\tan^{-1}\frac{y_{max}}{x_0} - \tan^{-1}\frac{y_0}{x_{max}}\right) \right] \end{eqnarray}
</p>
<p class="formulaDsp">
\begin{eqnarray} P^{even}_1 &amp;=&amp; \int_{y_0}^{y_{max}} y\sqrt{r^2-y^2} dy\\ &amp;=&amp; -\frac{1}{2}\int_{y_0}^{y_{max}}\sqrt{r^2-y^2} d(r^2-y^2)\\ &amp;=&amp; \frac{1}{3}\left(x_{max}^3 - x_0^3\right) \end{eqnarray}
</p>
<h2>Checking the solution:</h2>
<p>The best way to test if I made any errors in deriving the above is to differentiate the result and see if we get what we expect.</p>
<p>In particular we expect: </p><p class="formulaDsp">
\[ \frac{\partial I^{circ}_{m,n}}{\partial x_0} = \int_{y_0}^{y_{max}} dy x_0^m y^n = -x_0^m\frac{y_{max}^{n+1} - y_0^{n+1}}{n+1} \]
</p>
<p> And </p><p class="formulaDsp">
\[ \frac{\partial I^{circ}_{m,n}}{\partial y_0} = -y_0^n\frac{x_{max}^{m+1} - x_0^{m+1}}{m+1} \]
</p>
<p>Two useful identities: </p><p class="formulaDsp">
\[ \frac{\partial y_{max}}{\partial x_0}=-\frac{x_0}{y_max} \quad\mathrm{and}\quad \frac{\partial x_{max}}{\partial y_0}=-\frac{y_0}{x_max} \]
</p>
<h3>The derivative with respect to \(x_0\):</h3>
<p>From our solution: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial I^{circ}_{m,n}}{\partial x_0} &amp;=&amp; \frac{\partial}{\partial x_0}\left\{ \frac{1}{m+1}\int_{y_0}^{y_{max}} dy y^n \left[ Q_{m,n} - \frac{x_0^{m+1}}{n+1} \left(y_{max}^{n+1} - y_0^{n+1}\right) \right] \right\}\\ &amp;=&amp; \frac{1}{m+1}\frac{\partial Q_{m,n}}{\partial x_0} - x_0^m\frac{y_{max}^{n+1}-y_0^{n+1}}{n+1} + \frac{x_0^{m+2}y_{max}^{n-1}}{m+1} \end{eqnarray*}
</p>
<p>Since the second term is exactly what we want, we need the following to be satisfied: </p><p class="formulaDsp">
\[ \frac{\partial Q_{m,n}}{\partial x_0} = -x_0^{m+2}y_{max}^{n-1} \]
</p>
<p>From the solution: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial Q_{2k+1,n}}{\partial x_0} &amp;=&amp; -\sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i x_0 y_{max}^{n+2i-1}\\ &amp;=&amp; -x_0 y_{max}^{n-1} \sum_{i=0}^{k+1} {k+1 \choose i} (r^2)^{k+1-i} (-y_{max}^2)^i\\ &amp;=&amp; -x_0 y_{max}^{n-1}\left(r^2-y_{max}^2\right)^{k+1}\\ &amp;=&amp; -x_0^{2k+3} y_{max}^{n-1} \end{eqnarray*}
</p>
<p> Which is exactly what we needed.</p>
<p>Also from the solution: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial Q_{2k,n}}{\partial x_0} &amp;=&amp; \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i \frac{\partial P^{even}_{n+2i}}{\partial x_0}\\ \end{eqnarray*}
</p>
<p>So we need: </p><p class="formulaDsp">
\begin{eqnarray*} \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i \frac{\partial P^{even}_{n+2i}}{\partial x_0} &amp;=&amp; -x_0^{2k+2}y_{max}^{n-1}\\ &amp;=&amp; -x_0^2 y_{max}^{n-1} \sum_{i=0}^{i=k} {k \choose i} r^{2(k-i)} (-1)^i y_{max}^{2i} \end{eqnarray*}
</p>
<p> which translates to: </p><p class="formulaDsp">
\[ \frac{\partial P^{even}_{n+2i}}{\partial x_0} = -x_0^2 y_{max}^{n+2i-1} \]
</p>
<p> or </p><p class="formulaDsp">
\[ \frac{\partial P^{even}_n}{\partial x_0} = -x_0^2 y_{max}^{n-1} \]
</p>
<p> First: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial P^{even}_0}{\partial x_0} &amp;=&amp; \frac{1}{2}\left\{ y_{max} - \frac{x_0^2}{y_{max}} - r^2 \frac{1}{1+\frac{y_{max}^2}{x_0^2}} \left[ \frac{1}{y_{max}} + \frac{y_{max}}{x_0^2} \right] \right\}\\ &amp;=&amp; \frac{1}{2y_{max}}\left\{ y_{max}^2 - x_0^2 - r^2 \frac{x_0^2}{x_0^2+y_{max}} \left[ \frac{1} + \frac{y_{max}^2}{x_0^2} \right] \right\}\\ &amp;=&amp; \frac{1}{2y_{max}}\left( y_{max}^2 - x_0^2 - r^2\right)\\ &amp;=&amp; -\frac{x_0^2}{y_{max}} \end{eqnarray*}
</p>
<p> which is exactly what we needed.</p>
<p>Next: </p><p class="formulaDsp">
\[ \frac{\partial P^{even}_1}{\partial x_0}=-x_0^2 \]
</p>
<p> which is also what we needed.</p>
<p>Finally: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial P^{even}_n}{\partial x_0} &amp;=&amp; \frac{1}{n+2} \left((n-1)y_{max}^{n-3}x_0^4 - 3y_{max}^{n-1}x_0^2\right) + \frac{n-1}{n+2}r^2 \frac{\partial P^{even}_{n-2}}{\partial x_0}\\ &amp;=&amp; \frac{y_{max}^{n-3}x_0^2}{n+2} \left((n-1)x_0^2 - 3y_{max}^2\right) - \frac{n-1}{n+2}r^2 y_{max}^{n-3}x_0^2\\ &amp;=&amp; \frac{y_{max}^{n-3}x_0^2}{n+2} \left((n-1)x_0^2 - 3y_{max}^2 - (n-1)r^2\right)\\ &amp;=&amp; -y_{max}^{n-1}x_0^2 \end{eqnarray*}
</p>
<p> Which is the last piece we needed for the derivative with respect to \(x_0\).</p>
<h3>The derivative with respect to \(y_0\):</h3>
<p>From our solution: </p><p class="formulaDsp">
\[ \frac{\partial I^{circ}_{m,n}}{\partial y_0} = \frac{1}{m+1}\left( \frac{\partial Q_{m,n}}{\partial y_0} + x_0^{m+1} y_0^n \right) \]
</p>
<p>So we need: </p><p class="formulaDsp">
\[ \frac{\partial Q_{m,n}}{\partial y_0} = -x_{max}^{m+1} y_0^n \]
</p>
<p>From the solution: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial Q_{2k+1,n}}{\partial y_0} &amp;=&amp; -\sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i y_0^{n+2i}\\ &amp;=&amp; -y_0^n (r^2-y_0^2)^{k+1}\\ &amp;=&amp; -x_max^{2k+2} y_0^n \end{eqnarray*}
</p>
<p> Exactly what we need.</p>
<p>Also from the solution: </p><p class="formulaDsp">
\[ \frac{\partial Q_{2k,n}}{\partial y_0} = \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i \frac{\partial P^{even}_{n+2i}}{\partial y_0} \]
</p>
<p>So we need: </p><p class="formulaDsp">
\begin{eqnarray*} \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i \frac{\partial P^{even}_{n+2i}}{\partial y_0}\\ &amp;=&amp; -x_{max}^{2k+1}y_0^n\\ &amp;=&amp; -x_{max}\sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i y_0^{n+2i} \end{eqnarray*}
</p>
<p>In other words we must show that: </p><p class="formulaDsp">
\[ \frac{\partial P^{even}_n}{\partial y_0}=-x_{max} y_0^n \]
</p>
<p>First: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial P^{even}_0}{\partial y_0} &amp;=&amp; \frac{1}{2}\left[\frac{y_0^2}{x_{max}} - x_{max} -r^2 \frac{1}{1+\frac{y_0^2}{x_{max}^2}} \left( \frac{1}{x_{max}} + \frac{y_0^2}{x_{max}^3} \right) \right]\\ &amp;=&amp; \frac{1}{2x_{max}}\left[ y_0^2 - x_{max}^2 - r^2\frac{x_{max}^2}{x_{max}^2+y_0^2} \frac{x_{max}^2 + y_0^2}{x_{max}^2} \right]\\ &amp;=&amp; \frac{1}{2x_{max}}\left[ y_0^2 - x_{max}^2 - r^2 \right]\\ &amp;=&amp; -x_{max} \end{eqnarray*}
</p>
<p> Which matches our expectation.</p>
<p>Next: </p><p class="formulaDsp">
\[ \frac{\partial P^{even}_1}{\partial y_0} = - x_{max} y_0 \]
</p>
<p> Which also matches.</p>
<p>Finally, assuming \(\frac{\partial P^{even}_{n-2}}{\partial y_0} = -x_{max} y_0^{n-2}\) : </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial P^{even}_n}{\partial y_0} &amp;=&amp; \frac{1}{n+2} \left((n-1) y_0^{n-2}x_{max}^3 - 3 y_0^n x_{max}\right) + \frac{n-1}{n+2}r^2 \frac{\partial P^{even}_{n-2}}{\partial y_0}\\ &amp;=&amp; \frac{1}{n+2} \left((n-1) y_0^{n-2}x_{max}^3 - 3 y_0^n x_{max}\right) - \frac{n-1}{n+2}r^2 x_{max} y_0^{n-2}\\ &amp;=&amp; \frac{x_{max}}{n+2}\left((n-1) y_0^{n-2}x_{max}^2 - 3 y_0^n - (n-1)r^2 y_0^{n-2} \right)\\ &amp;=&amp; -x_{max} y_0^n \end{eqnarray*}
</p>
<p> Which was the last missing piece.</p>
<h2>Deriving the relation between \(Q_{m,n}\) quantities.</h2>
<p>For odd \(m\): </p><p class="formulaDsp">
\begin{eqnarray*} Q_{2k+3,n} &amp;=&amp; \sum_{i=0}^{k+2} {k+2 \choose i} r^{2(k+2-i)} (-1)^i P^{odd}_{n+2i}\\ &amp;=&amp; \sum_{i=0}^{k+2} \left[{k+1 \choose i} + {k+1 \choose i-1}\right] r^{2(k+2-i)} (-1)^i P^{odd}_{n+2i}\\ &amp;=&amp; r^2 Q_{2k+1,n} + \sum_{i=1}^{k+2} {k+1 \choose i-1} r^{2(k+2-i)} (-1)^i P^{odd}_{n+2i}\\ &amp;=&amp; r^2 Q_{2k+1,n} - \sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i P^{odd}_{n+2+2i}\\ &amp;=&amp; r^2 Q_{2k+1,n} - Q_{2k+1,n+2} \end{eqnarray*}
</p>
<p>For even \(m\): </p><p class="formulaDsp">
\begin{eqnarray*} Q_{2k+2,n} &amp;=&amp; \sum_{i=0}^{k+1} {k+1 \choose i} r^{2(k+1-i)} (-1)^i P^{even}_{n+2i}\\ &amp;=&amp; \sum_{i=0}^{k+1} \left[{k \choose i} + {k \choose i-1}\right] r^{2(k+1-i)} (-1)^i P^{even}_{n+2i}\\ &amp;=&amp; r^2Q_{2k,n} + \sum_{i=1}^{k+1} {k \choose i-1} r^{2(k+1-i)} (-1)^i P^{even}_{n+2i}\\ &amp;=&amp; r^2Q_{2k,n} - \sum_{i=0}^{k} {k \choose i} r^{2(k-i)} (-1)^i P^{even}_{n+2+2i}\\ &amp;=&amp; r^2Q_{2k,n} - Q_{2k,n+2} \end{eqnarray*}
</p>
<p>Actually, this relation is obvious from the definition of \(Q_{m,n}\). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 21 2024 21:16:51 for Sub-Pixel Photometry by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
