<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SuperPhot: PiecewiseBicubicFitPSF</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SuperPhot
   &#160;<span id="projectnumber">unspecified</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('PiecewiseBicubicFitPSF_main_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PiecewiseBicubicFitPSF </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Fitting for position dependent values and derivatives of piecewise bicubic <a class="el" href="namespacePSF.html">PSF</a> models.</p>
<p>In the piecewise bicubic <a class="el" href="namespacePSF.html">PSF</a> model the <a class="el" href="namespacePSF.html">PSF</a> is split into a grid of cells and the intensity over each cell is assumed to be given by a bi-cubic function.</p>
<p>Requiring the continuity of the first order derivatives with respect to x and y as well as the cross derivative of the <a class="el" href="namespacePSF.html">PSF</a> dramatically reduces the number of free parameters. In fact the <a class="el" href="namespacePSF.html">PSF</a> is fully specified by the values, the x and y derivatives and the xy cross derivatives at the grid points.</p>
<p>Since we want the <a class="el" href="namespacePSF.html">PSF</a> to vary smoothly accross the image we will assume that these quantities are given by a polynomial expansion accross the image. Further, the grid points lying on the outside edge of the grid will be assumed to have a value and all derivatives equal to zero.</p>
<p>The grid giving the splitting of the <a class="el" href="namespacePSF.html">PSF</a> will be defined by a set of vertical boundaries with coordinates <img class="formulaInl" alt="$ \{x_i\} $" src="form_57.png"/> (i=0...M) relative to the source center and horizontal boundaries with coordinates <img class="formulaInl" alt="$ \{y_j\} $" src="form_58.png"/> (j=0...N) relative to the source center. Let <img class="formulaInl" alt="$ \{V_{i,j}\} $" src="form_59.png"/> be the values, <img class="formulaInl" alt="$ \{D^x_{i,j}\} $" src="form_60.png"/> the horizontal derivatives, <img class="formulaInl" alt="$ \{D^y_{i,j}\} $" src="form_61.png"/> the vertical derivatives, and <img class="formulaInl" alt="$ \{D^{xy}_{i,j}\} $" src="form_62.png"/> the cross derivatives of the <a class="el" href="namespacePSF.html">PSF</a> at the grid points. Let <img class="formulaInl" alt="$ \mathbf{Q} $" src="form_63.png"/> be a vector of these quantities excluding those on the outside grid edge.</p>
<p>We need to impose that the integral of the <a class="el" href="namespacePSF.html">PSF</a> over the entire grid is one (scaling this by a factor is degenerate with scaling the amplitudes for all sources by the inverse factor). That can be imposed by noting that the integral of the <a class="el" href="namespacePSF.html">PSF</a> over the grid is given by <img class="formulaInl" alt="$ \mathbf{I^TQ} $" src="form_64.png"/> for some column vector <img class="formulaInl" alt="$ \mathbf{I} $" src="form_65.png"/>. We then decompose <img class="formulaInl" alt="$ \mathbf{Q}=\mathbf{I}/I^2+\sum q_i \mathbf{e}_i $" src="form_66.png"/> where <img class="formulaInl" alt="$ I^2 $" src="form_67.png"/> is the square norm of <img class="formulaInl" alt="$ \mathbf{I} $" src="form_65.png"/> and <img class="formulaInl" alt="$ \mathbf{e}_i $" src="form_68.png"/> are an orthonormal basis for the space perpendicular to <img class="formulaInl" alt="$ \mathbf{I} $" src="form_65.png"/>. Note that the SVD decomposition of <img class="formulaInl" alt="$ \mathbf{I}^T $" src="form_69.png"/> has <img class="formulaInl" alt="$ \mathbf{U}=(1) $" src="form_70.png"/>, <img class="formulaInl" alt="$ \mathbf{S}=(I, 0, 0, ...) $" src="form_71.png"/> and the first columns of <img class="formulaInl" alt="$ \mathbf{V} $" src="form_72.png"/> is <img class="formulaInl" alt="$ \mathbf{I}/I $" src="form_73.png"/> and the remaining columns can be used as the <img class="formulaInl" alt="$ \mathbf{e}_i $" src="form_68.png"/>. We will then fit for the spatially dependent <img class="formulaInl" alt="$ q_i $" src="form_74.png"/>:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_i=\sum_{k,l}q_{i,k,l}x^ky^l \]" src="form_75.png"/>
</p>
<p>where <img class="formulaInl" alt="$ x $" src="form_76.png"/> and <img class="formulaInl" alt="$ y $" src="form_77.png"/> are the image coordinates of the center of the source for which the <a class="el" href="namespacePSF.html">PSF</a> is being constructed.</p>
<p>With these definitions, in order to fully specify <a class="el" href="namespacePSF.html">PSF</a> of each single source in an input image we need the quantities <img class="formulaInl" alt="$ q_{i,k,l} $" src="form_78.png"/>, where i is in the range 0 to (M-2)(N-2)-1, and the ranges for k and l depend on the order of the polynomial used to describe the <a class="el" href="namespacePSF.html">PSF</a> variability over the image, so we need to fit for those.</p>
<p>Note that the coefficients of the bi-cubic polynomials specifying the <a class="el" href="namespacePSF.html">PSF</a> in each grid cell depend linearly on the values and derivatives at the grid nodes, which can be reconstructed from the quantities we fit for. In turn, the integrals of the <a class="el" href="namespacePSF.html">PSF</a> over CCD (sub-)pixels depends linearly on the bi-cubic coefficients.</p>
<p>So if we somehow knew the fluxes of all the sources as well as their positions, we could constuct a matrix ( <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/>) such that: <img class="formulaInl" alt="$ \mathbf{Mq}+\mathbf{\Delta} $" src="form_80.png"/> predicts the values of all image pixels assigned to any source scaled by the flux of that source. Where <img class="formulaInl" alt="$ \mathbf{q} $" src="form_81.png"/> is the vector of the <img class="formulaInl" alt="$ q_{i,k,l} $" src="form_78.png"/> unknowns and <img class="formulaInl" alt="$ \Delta $" src="form_82.png"/> is the integral of a <a class="el" href="namespacePSF.html">PSF</a> specified entirely by <img class="formulaInl" alt="$ \mathbf{I} $" src="form_65.png"/> over the corresponding pixel. So <img class="formulaInl" alt="$ \mathbf{q} $" src="form_81.png"/> can be obtained by multiplying the rows of <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/> and <img class="formulaInl" alt="$ \mathbf{\Delta} $" src="form_83.png"/> by the amplitude of the corresponding source and percforming a least squares fit. Since deriving the fluxes of the sources requires the <a class="el" href="namespacePSF.html">PSF</a>, we iterate. We begin by estimating the flux of each source by simply summing all the pixel values (in excess of the background) assigned to it or by aperture photometry. Then for each source we multiply the piece of the <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/> matrix that corresponds to that source's pixels by the current flux estimate and use the new matrix in a linear fit for the <a class="el" href="namespacePSF.html">PSF</a>. Finally, we update the flux estimates by using the new <a class="el" href="namespacePSF.html">PSF</a> model. This is repeated until the flux estimates stop changing too much.</p>
<h2>The Algorithm </h2>
<p>Directly constructing <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/> is counter productive. For even modest grids (say 12x12 cells) and a reasonable number of sources used from a real image (say 3000 each with an average of 50 pixels assigned to it) and a reasonable expansion order (say 4) would result in unmanageable matrix sizes ( <img class="formulaInl" alt="$ 2\times10^9 $" src="form_84.png"/> elements in our example). Such matrices are hard to even allocate let alone solve. However, <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/> is of a special form which makes this unnecessary. In order to perform a least squares fit we need to multiply the RHS by <img class="formulaInl" alt="$ \mathbf{M}^T $" src="form_85.png"/> (let the result be denoted by <img class="formulaInl" alt="$ \mathbf{r'} $" src="form_86.png"/> and then solve <img class="formulaInl" alt="$ \mathbf{M}^T\,\mathbf{M}\,\mathbf{x}=\mathbf{r'} $" src="form_87.png"/>. The matrix <img class="formulaInl" alt="$ \Lambda\equiv\mathbf{M}^T\,\mathbf{M} $" src="form_88.png"/> has only <img class="formulaInl" alt="$ n^2K^2 $" src="form_89.png"/> elements ( <img class="formulaInl" alt="$ 5.3 \times 10^7 $" src="form_90.png"/> in our example), which is reasonable to allocate and invert. Even more, calculating <img class="formulaInl" alt="$ \mathbf{\Lambda} $" src="form_91.png"/> by first calculating <img class="formulaInl" alt="$ \mathbf{M} $" src="form_79.png"/> is slower than the algorithm described below, and actually will dominate the computational time for non-trivial uses.</p>
<p>Let:</p><ul>
<li><img class="formulaInl" alt="$ \mathcal{O} $" src="form_92.png"/> - the polynomial expansion order</li>
<li><img class="formulaInl" alt="$ G_x,G_y $" src="form_93.png"/> - number of grid boundaries in the x and y direction respectively</li>
<li>S - number of sources</li>
<li><img class="formulaInl" alt="$ p_i $" src="form_94.png"/> - number of pixels assigned to the i-th source.</li>
<li>P - number of pixels in the input image assigned to all sources (i.e. <img class="formulaInl" alt="$ P\equiv\sum_{i=0}^S p_i $" src="form_95.png"/>)</li>
<li>K - number of terms in the polynomial expansion of a single <a class="el" href="namespacePSF.html">PSF</a> coefficient (i.e. K= <img class="formulaInl" alt="$ \mathcal{O}+1)(\mathcal{O}+2)/2 $" src="form_96.png"/>).</li>
<li>n - number of parameters defining a single psf (i.e. n= <img class="formulaInl" alt="$ 4(G_x-2)(G_y-2)-1 $" src="form_97.png"/>)</li>
<li><img class="formulaInl" alt="$ r $" src="form_98.png"/> - vector of the background excess values of all pixels assigned to sources</li>
<li><img class="formulaInl" alt="$ \mathbf{I} $" src="form_65.png"/> - vector which when dotted with the <a class="el" href="namespacePSF.html">PSF</a> parameters ( <img class="formulaInl" alt="$ \{V_{i,j}\} $" src="form_59.png"/>, <img class="formulaInl" alt="$ \{D^x_{i,j}\} $" src="form_60.png"/>, <img class="formulaInl" alt="$ \{D^y_{i,j}\} $" src="form_61.png"/>, and <img class="formulaInl" alt="$ \{D^{xy}_{i,j}\} $" src="form_62.png"/>) gives the integral of the <a class="el" href="namespacePSF.html">PSF</a> over the entire grid.</li>
<li><img class="formulaInl" alt="$ \Delta $" src="form_82.png"/> - Integrals of PSFs whose parameters are given by <img class="formulaInl" alt="$ \mathbf{I}/I^2 $" src="form_99.png"/> over the source pixels.</li>
<li><img class="formulaInl" alt="$ \mathbf{\tilde{M}}^i $" src="form_100.png"/> - a set of matrices, one for each source, with each row consisting of the integrals over the same source pixel but with only one <img class="formulaInl" alt="$ q_i $" src="form_74.png"/> being non-zero. The dimensions of the i-th matrix are <img class="formulaInl" alt="$ p_i\times n $" src="form_101.png"/>.</li>
<li><img class="formulaInl" alt="$ \mathbf{\Lambda}^i\equiv(\mathbf{\tilde{M}}^i)^T\mathbf{\tilde{M}}^i $" src="form_102.png"/></li>
<li><img class="formulaInl" alt="$ \mathbf{\kappa^i} $" src="form_103.png"/> - a set of row-vectors, one for each source, containing the polynomial expansion terms (i.e. <img class="formulaInl" alt="$ \left(1, x, y, x^2, xy, \cdots, y^\mathcal{O}\right) $" src="form_104.png"/>)</li>
<li><img class="formulaInl" alt="$ f_i $" src="form_105.png"/> - current best estimate of the source flux</li>
</ul>
<p>With these definitions: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{\Lambda}=\left(\begin{array}{ccccccc} \nwarrow &amp; \uparrow &amp; \nearrow &amp; \nwarrow &amp; \uparrow &amp; \nearrow \\ \longleftarrow &amp; \sum_{i=0}^S f_i^2 \Lambda^i_{1,1} (\mathbf{\kappa^i})^T \mathbf{\kappa^i} &amp; \longrightarrow &amp; \longleftarrow &amp; \sum_{i=0}^S f_i^2 \Lambda^i_{1,2} (\mathbf{\kappa^i})^T\mathbf{\kappa^i} &amp; \longrightarrow &amp; \cdots \\ \swarrow &amp; \downarrow &amp; \searrow &amp; \swarrow &amp; \downarrow &amp; \searrow \\ \\ \nwarrow &amp; \uparrow &amp; \nearrow &amp; \nwarrow &amp; \uparrow &amp; \nearrow \\ \longleftarrow &amp; \sum_{i=0}^S f_i^2 \Lambda^i_{2,1} (\mathbf{\kappa^i})^T\mathbf{\kappa^i} &amp; \longrightarrow &amp; \longleftarrow &amp; \sum_{i=0}^S f_i^2 \Lambda^i_{2,2} (\mathbf{\kappa^i})^T\mathbf{\kappa^i} &amp; \longrightarrow &amp; \cdots \\ \swarrow &amp; \downarrow &amp; \searrow &amp; \swarrow &amp; \downarrow &amp; \searrow \\ &amp; \vdots &amp; &amp; &amp; \vdots &amp; &amp; \ddots \end{array}\right) \]" src="form_106.png"/>
</p>
<p>So the algorithm we will use for <a class="el" href="namespacePSF.html">PSF</a> fitting is as follows.</p>
<h3>One Time Initialization</h3>
<p>Overall Complexity: <img class="formulaInl" alt="$ P\,n^2 $" src="form_107.png"/></p>
<ol type="1">
<li>Obtain an initial estimate of the source fluxes (aperture photometry with flat <a class="el" href="namespacePSF.html">PSF</a>), the <img class="formulaInl" alt="$ r $" src="form_98.png"/> and <img class="formulaInl" alt="$ \Delta $" src="form_82.png"/> vectors. <b>Complexity</b>: large constant times S.</li>
<li><p class="startli">For each source:</p>
<p class="startli">2.1 construct the corresponding <img class="formulaInl" alt="$ \mathbf{\tilde{M}^i} $" src="form_108.png"/> matrix and stack them together in <img class="formulaInl" alt="$ \mathbf{\tilde{M}} $" src="form_109.png"/>. <b>Complexity</b>: large constant times <img class="formulaInl" alt="$ n\,S $" src="form_110.png"/>.</p>
<p class="startli">2.2 For each source apply <img class="formulaInl" alt="$ (\mathbf{\tilde{M}^i})^T $" src="form_111.png"/> to the corresponding piece of the <img class="formulaInl" alt="$ r $" src="form_98.png"/> vector, storing the result as <img class="formulaInl" alt="$ \mathbf{\tilde{r}}^i $" src="form_112.png"/> a part of a permanent vector <img class="formulaInl" alt="$ \mathbf{\tilde{r}} $" src="form_113.png"/> (will have a total length of <img class="formulaInl" alt="$ S\,n $" src="form_114.png"/>). <b>Complexity</b>: <img class="formulaInl" alt="$ P\,n $" src="form_115.png"/>. </p><pre class="fragment">2.3 Repeat \form#82 storing the result as
</pre><p> <img class="formulaInl" alt="$ \mathbf{\tilde{\Delta}} $" src="form_116.png"/>. </p><pre class="fragment">2.4 Calculate
</pre><p> <img class="formulaInl" alt="$ \mathbf{\tilde{\Lambda}^i} = (\mathbf{\tilde{M}^i})^T\,\mathbf{\tilde{M}^i} $" src="form_117.png"/> and store the result as part of the permament matrix <img class="formulaInl" alt="$ \mathbf{\tilde{\Lambda}} $" src="form_118.png"/> (a stack of the individual <img class="formulaInl" alt="$ \mathbf{\tilde{\Lambda}^i} $" src="form_119.png"/> matrices). <b>Complexity</b>: <img class="formulaInl" alt="$ P\,n^2 $" src="form_107.png"/>.</p>
</li>
<li>Calculate a stack of <img class="formulaInl" alt="$ (\mathbf{\kappa^i})^T\mathbf{\kappa^i} $" src="form_120.png"/> matrices (<b>complexity</b>: <img class="formulaInl" alt="$ S\,K^2 $" src="form_121.png"/>).</li>
</ol>
<h3>Estimates for The Expansion Coefficients of the <a class="el" href="namespacePSF.html">PSF</a> Parameters</h3>
<p>Overall Complexity <img class="formulaInl" alt="$ S\,n^2\,K^2 $" src="form_122.png"/></p>
<ol type="1">
<li>Compute the <img class="formulaInl" alt="$ \mathbf{\Lambda} $" src="form_91.png"/> matrix as it is written above (<b>complexity</b>: <img class="formulaInl" alt="$ S\,n^2\,K^2 $" src="form_122.png"/>).</li>
<li>Compute: <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{r'}=\left(\begin{array}{c} \sum_{i=0}^S (\mathbf{\tilde{\kappa}^i})^T f_i (\tilde{r}^i_1-f_i\tilde{\Delta}^i_1)\\ \sum_{i=0}^S (\mathbf{\tilde{\kappa}^i})^T f_i (\tilde{r}^i_2-f_i\tilde{\Delta}^i_2)\\ \vdots\\ \sum_{i=0}^S (\mathbf{\tilde{\kappa}^i})^T f_i (\tilde{r}^i_n-f_i\tilde{\Delta}^i_n\\ \end{array}\right) \]" src="form_123.png"/>
</p>
 <b>complexity</b>: <img class="formulaInl" alt="$ n\,K $" src="form_124.png"/></li>
<li>Use LDLT decomposition to solve for the (updated) expansion coefficients (<b>complexity</b>: <img class="formulaInl" alt="$ n^3\,K^3 $" src="form_125.png"/>).</li>
</ol>
<h3>Estimates for the Source Amplitudes.</h3>
<p>This is a simple linear regression for the background excesses of each source using its current best fit <a class="el" href="namespacePSF.html">PSF</a>.</p>
<h2>Smoothing. </h2>
<p>In the case of fitting extremely sharp sources or very sparse images it is possible that there will not be enough stars or enough pixels within a star to constrain a grid, and yet there may be features of the <a class="el" href="namespacePSF.html">PSF</a> which require a fine grid to be used. In this case noise ends up being fitted and the resulting <a class="el" href="namespacePSF.html">PSF</a> has large amplitude high frequency components. This is clearly not physical and needs to be avoided in order to get stable photometry. In order to handle these cases piecewise bicubic <a class="el" href="namespacePSF.html">PSF</a> fitting support smoothing. This is implemented by adding the integral of the square of the second derivative in both x and y over the entire <a class="el" href="namespacePSF.html">PSF</a> to the function being minimized:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \tilde{\chi}^2 \equiv \frac{10^\sigma}{S}\sum_{s=1}^S \left( \frac{\partial^4 f_s(x,y)} {\partial x^2 \partial y^2} \right)^2 + \sum_{s=1}^S \sum_{j=1}^{p_i} \left(A_i\int_{pixel(i,j)} f_s(x,y) dx dy - r_i^j\right)^2 \]" src="form_126.png"/>
</p>
<p>Adding the first term above, which is what is missing from the description above is actually quite simple. It can be expressed as the sum of terms containing constants and second order combinations of the <a class="el" href="namespacePSF.html">PSF</a> parameters. This in turn can be achieved by adding an extra <img class="formulaInl" alt="$ \mathbf{\tilde{M}}^i $" src="form_100.png"/> matrix and a corresponding source with all zero fluxes. However, this extra matrix will not be multiplied by a <img class="formulaInl" alt="$ \kappa^T\kappa $" src="form_127.png"/>, but instead by the average of that over all sources.</p>
<p>In order to add the first we need to write it as a sum of squares of the difference between a linear transformation of the <img class="formulaInl" alt="$ q_i $" src="form_74.png"/> parameters and some right hand side vector.</p>
<p>In the following let i and j be indices identifyin a grid cell (i is the grid column and j is the grid row) and let <img class="formulaInl" alt="$ c^{i,j}_{m,n;s} $" src="form_128.png"/> be the coefficient in front of <img class="formulaInl" alt="$ x^m y^n $" src="form_129.png"/> term in the <a class="el" href="namespacePSF.html">PSF</a> funciton of source number <img class="formulaInl" alt="$s$" src="form_130.png"/> over the <img class="formulaInl" alt="$ (i,\ j) $" src="form_131.png"/> cell. In what follows we will drop the i, j and s indices for shorter notation. Then:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_{grid} dx dy \left( \frac{\partial^4 f_s(x,y)}{\partial x^2 \partial y^2} \right)^2 = \sum_{i,j} \Bigg(&amp;&amp; \\ &amp;&amp; 16 c_{2,2}^2 w h \\ &amp;&amp; + 48 c_{2,3}^2 w h^3 \\ &amp;&amp; + 48 c_{3,2}^2 w^3 h \\ &amp;&amp; + 144 c_{3,3}^2 w^3 h^3 \\ &amp;&amp; + 48 c_{2,2} c_{2,3} w h^2 \\ &amp;&amp; + 48 c_{2,2} c_{3,2} h^2 w \\ &amp;&amp; + 72 c_{2,2} c_{3,3} w^2 h^2 \\ &amp;&amp; + 72 c_{2,3} c_{3,2} w^2 h^2 \\ &amp;&amp; + 144 c_{2,3} c_{3,3} w^2 h^3 \\ &amp;&amp; + 144 c_{3,2} c_{3,3} w^3 h^2 \\ \Bigg) \\ = \sum_{i,j} w h \Bigg(&amp;&amp; \\ &amp;&amp; 16 c_{2,2}^2 \\ &amp;&amp; + 48 c_{2,3}^2 h^2 \\ &amp;&amp; + 48 c_{3,2}^2 w^2 \\ &amp;&amp; + 144 c_{3,3}^2 w^2 h^2 \\ &amp;&amp; + 48 c_{2,2} c_{2,3} h \\ &amp;&amp; + 48 c_{2,2} c{3,2} w \\ &amp;&amp; + 72 c_{2,2} c_{3,3} w h \\ &amp;&amp; + 72 c_{2,3} c_{3,2} w h \\ &amp;&amp; + 144 c_{2,3} c_{3,3} w h^2 \\ &amp;&amp; + 144 c_{3,2} c_{3,3} w^2 h \\ \Bigg) \end{eqnarray*}" src="form_132.png"/>
</p>
<p> where <img class="formulaInl" alt="$ w,\ h $" src="form_133.png"/> are the width and height of the grid cell. Since this is a quadratic form in <img class="formulaInl" alt="$ c_{m,n} $" src="form_134.png"/>, it can be written as: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_{grid} dx dy \left( \frac{\partial^4 f_{x_0, y_0}(x,y)}{\partial x^2 \partial y^2} \right)^2 = \mathbf{C}^T \mathbf{A} \mathbf{C} \]" src="form_135.png"/>
</p>
<p> where <img class="formulaInl" alt="$ \mathbf{C}^T=(C^{0,0}_{2,2}, C^{0,0}_{2,3}, C^{0,0}_{3,2}, C^{0,0}_{3,3}, C^{1,0}, \ldots) $" src="form_136.png"/> and A is a symmetric matrix which consists of matrices of the following form along its diagonal: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{A_{cell}}=w h \left(\begin{array}{cccc} 16 &amp; 24 h &amp; 24 w &amp; 36 w h \\ 24 h &amp; 48 h^2 &amp; 36 w h &amp; 72 w h^2 \\ 24 w &amp; 36 w h &amp; 48 w^2 &amp; 72 w^2 h \\ 36 w h &amp; 72 w h^2 &amp; 72 w^2 h &amp; 144 w^2 h^2 \end{array}\right) \]" src="form_137.png"/>
</p>
<p> Since <img class="formulaInl" alt="$ \mathbf{A} $" src="form_138.png"/> is symmetric it can be written as <img class="formulaInl" alt="$ \mathbf{E}^T \mathbf{\Lambda} \mathbf{E} $" src="form_139.png"/> where <img class="formulaInl" alt="$ \mathbf{E} $" src="form_140.png"/> is orthogonal and <img class="formulaInl" alt="$ \mathbf{\Lambda} $" src="form_91.png"/> is diagonal containing the eigenvalues of <img class="formulaInl" alt="$ \mathbf{A} $" src="form_138.png"/>. Which can clearly be written as <img class="formulaInl" alt="$ \mathbf{A} = \mathbf{B}^T\mathbf{B} $" src="form_141.png"/> with <img class="formulaInl" alt="$ \mathbf{B}=\sqrt{\mathbf{\Lambda}} \mathbf{E} $" src="form_142.png"/>.</p>
<p>Further: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{C} = \mathbf{\Phi} \mathbf{q} = \mathbf{\Phi}\left( \mathbf{I}/I^2 + \sum_{i,k} q_{i,k} \kappa_k \mathbf{e}_i \right) \]" src="form_143.png"/>
</p>
<p>So we end up with: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ S\equiv \sum_{s=1}^S \int_{grid} dx dy \left( \frac{\partial^4 f_s(x,y)}{\partial x^2 \partial y^2} \right)^2 = \sum_{s=1}^S \sum_{c} \left[ \sum_{d,e} B_{c,d} \Phi_{d,e} \left( I_e/I^2 + \sum_{i,k} q_{i,k} \kappa^s_k \mathbf{e}_{i,e} \right) \right]^2 \]" src="form_144.png"/>
</p>
<p>To find the minimum differentiate: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \frac{\partial S}{\partial q_{\sigma,\mu}} &amp;=&amp; 2 \sum_{s=1}^S \sum_{c} \left[ \sum_{d,e} B_{c,d} \Phi_{d,e} \left( I_e/I^2 + \sum_{i,k} q_{i,k} \kappa^s_k \mathbf{e}_{i,e} \right) \right] \left[ \sum_{\delta,\varepsilon} B_{c,\delta} \Phi_{\delta,\varepsilon} \left( \kappa^s_\mu e_{\sigma,\varepsilon} \right) \right]\\ &amp;=&amp; 2 \sum_{s=1}^S \kappa^s_{\mu} \mathbf{e}_{\sigma}^T\mathbf{\Phi}^T\mathbf{B}^T \mathbf{B} \mathbf{\Phi} \left( \mathbf{I}/I^2 + \sum_{i,k} q_{i,k} \kappa^s_k \mathbf{e}_{i} \right)\\ &amp;=&amp; \frac{2}{I^2} \mathbf{e}_{\sigma}^T\mathbf{\Phi}^T\mathbf{A}\mathbf{\Phi} \mathbf{I} \sum_{s=1}^S \kappa^s_{\mu} + \frac{2}{I^2} \mathbf{e}_{\sigma}^T\mathbf{\Phi}^T\mathbf{A}\mathbf{\Phi} \sum_{s=1}^S \sum_{i,k} q_{i,k} \kappa^s_{\mu} \kappa^s_k \mathbf{e}_{i} \end{eqnarray*}" src="form_145.png"/>
</p>
<p> The first term needs to be added to the <img class="formulaInl" alt="$ \mathbf{r}' $" src="form_146.png"/> vector and the matrix identified by the second term must be added to the <img class="formulaInl" alt="$ \mathbf{\Lambda} $" src="form_91.png"/> matrix.</p>
<p>Conveniently, neither correction depends on the current values of the parameters, so we can compute those once for a given grid and simply add them at each step, thus not resulting in any significant overhead to the fitting. Further the non-smoothing algorithm already computes the bicubic coefficients over each grid cell for the selected basis vector so we have <img class="formulaInl" alt="$ \mathbf{\Phi} \mathbf{I}/I^2 $" src="form_147.png"/> and <img class="formulaInl" alt="$ \mathbf{\Phi} \mathbf{e}_i $" src="form_148.png"/> for all <img class="formulaInl" alt="$ \mathbf{e}_i $" src="form_68.png"/>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Dec 14 2017 00:23:04 for SuperPhot by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
